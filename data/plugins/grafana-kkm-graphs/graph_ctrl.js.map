{"version":3,"sources":["../src/graph_ctrl.js"],"names":["MetricsPanelCtrl","moment","_","TimeSeries","echarts","$","panelDefaults","mode","kksTitle","unit","detail","alarmColor","EchartsCtrl","$scope","$injector","$rootScope","defaults","panel","modeOption","name","value","events","on","onInitEditMode","bind","onDataReceived","unitOption","addEditorTab","dataList","render","alarmCode","p","scope","elem","attrs","ctrl","pageCount","getTableHeight","panelHeight","height","datasource","url","console","warn","dataJson","GE","GB","i","length","kks","s","substring","push","precise","toFixed","rootElem","find","css","templateUrl"],"mappings":"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","file":"graph_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport moment from 'moment';\r\nimport _ from 'lodash';\r\nimport TimeSeries from 'app/core/time_series';\r\nimport './css/clock-panel.css!';\r\nimport echarts from 'vendor/echarts/echarts.min.js';\r\nimport $ from 'jquery';\r\n\r\n\r\nvar panelDefaults = {\r\n\tmode: 'all', //展示方式：all 主页面，detail：指标量列表\r\n\tkksTitle: \"XX智慧检修平台\",\r\n\tunit: 1, //默认机组\r\n\tdetail: \"\", //显示指标量的模板名称\r\n\talarmColor:[\"rgba(0, 255, 0, 0.7)\", \"rgba(0, 170, 0, 0.7)\", \"rgba(255, 255, 0, 0.7)\", \"rgba(255, 0, 0, 0.7)\"] //告警颜色等级0-3 00ff00\\00aa00\\ffff00,#ff0003\r\n};\r\n\r\nexport class EchartsCtrl extends MetricsPanelCtrl {\r\n  constructor($scope, $injector, $rootScope) {\r\n    super($scope, $injector);\r\n\tthis.$rootScope = $rootScope;\r\n\t\r\n\t_.defaults(this.panel, panelDefaults); //将panelDefaults属性附加到this.panel上\r\n\tvar modeOption = [\r\n      {name: '指标分类', value: \"all\"},\r\n\t  {name: '详细指标级', value: \"detail\"}\r\n    ];\r\n\tthis.panel.modeOption = modeOption;\r\n\t\r\n\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n  }\r\n  \r\n  onInitEditMode() {\r\n\tvar unitOption = [\r\n      {name: '1号机组', value: 1},\r\n\t  {name: '2号机组', value: 2},\r\n\t  {name: '3号机组', value: 3},\r\n\t  {name: '4号机组', value: 4},\r\n    ];\r\n\tthis.panel.unitOption = unitOption;\r\n    this.addEditorTab('Options', 'public/plugins/grafana-kkm-graphs/editor.html', 2);\r\n  }\r\n  \r\n  onDataReceived(dataList) {\r\n\tthis.dataList = dataList;\r\n\tthis.render();\r\n  }\r\n  \r\n  //link中起到监听作用\r\n  onRender(){\r\n  }\r\n  \r\n  //p = this.panel.alarmColor[status];\r\n  setColor(alarmCode) {\r\n\t\tvar p = \"\";\r\n\t\tif (alarmCode <= 3) {\r\n\t\t\tp = this.panel.alarmColor[alarmCode];\r\n\t\t}else{\r\n\t\t\tp = '';\r\n\t\t}\r\n\t\treturn {\"background-color\": p};\r\n\t};\r\n   \r\n  link(scope, elem, attrs, ctrl) {\r\n\t var pageCount = 0;\r\n\t//table高度\r\n    function getTableHeight() {\r\n      var panelHeight = ctrl.height;\r\n      if (pageCount > 1) {\r\n        panelHeight -= 30;\r\n      }\r\n      return (panelHeight - 31) + 'px';\r\n    }\r\n\t\r\n\tctrl.events.on('render', function() {\r\n\t\tif(ctrl.panel.mode == \"all\"){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif(!ctrl.datasource || !ctrl.datasource.url){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tif(ctrl.panel.mode == \"detail\" && ctrl.panel.detail == \"\"){\r\n\t\t\tconsole.warn(\"没有设置指标量模板\");\r\n\t\t}\r\n\t\t\r\n\t\tvar dataJson = ctrl.dataList;\r\n\t\t\r\n\t\t//KPI分类：运行监控GE，安装调试GB ; kks 29-31位标识\r\n\t\tvar GE = [];\r\n\t\tvar GB = [];\r\n\t\tfor(var i=0; i<dataJson.length; i++){\r\n\t\t\tif(dataJson[i].kks && dataJson[i].kks.length >= 33){\r\n\t\t\t\tvar s = dataJson[i].kks.substring(29, 31);\r\n\t\t\t\tif(s == \"GB\"){\r\n\t\t\t\t\tGB.push(dataJson[i]);\r\n\t\t\t\t}else if(s == \"GE\"){\r\n\t\t\t\t\tGE.push(dataJson[i]);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.warn(\"错误的监测量 ：\" + dataJson[i].kks);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(dataJson[i].value && dataJson[i].precise){\r\n\t\t\t\tdataJson[i].value = dataJson[i].value.toFixed(dataJson[i].precise);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(dataJson[i].value == -9999 || dataJson[i].value == '-9999'){\r\n\t\t\t\tdataJson[i].value = \"-\";\r\n\t\t\t}\r\n\t\t}\r\n\t\tctrl.panel.GE = GE;\r\n\t\tctrl.panel.GB = GB;\r\n\t\t\r\n\t\tvar rootElem = elem.find('.table-panel-scroll'); //表格需要处理高度\r\n\t\tpageCount = ctrl.panel.GB.length > ctrl.panel.GE.length ? ctrl.panel.GB.length : ctrl.panel.GE.length;\r\n\t\trootElem.css({'max-height': getTableHeight()});\r\n\t});\r\n  }\r\n}\r\n\r\nEchartsCtrl.templateUrl = 'module.html';\r\n"]}