{"version":3,"sources":["../src/text_ctrl.js"],"names":["MetricsPanelCtrl","moment","_","$","panelDefaults","remarkable","mode","content","isCycle","time","information","fontSize","TextPanelCtrl","$scope","$injector","templateSrv","$sce","defaults","panel","events","on","onInitEditMode","bind","onDataReceived","addEditorTab","dataList","data","length","datapoints","i","da","obj","Number","parseInt","format","push","showData","render","replace","updateContent","System","import","then","Remarkable","$apply","ht","newString","str","match","key","trim","html","trustAsHtml","scopedVars","e","console","log","renderMarkdown","renderText","renderLogHtml","renderingCompleted","scope","elem","attrs","ctrl","find","css","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACCA,mB,kBAAAA,gB;;AAEMC,S;;AAEAC,I;;AACAC,I;;;;;;;;;;;;;;;;;;;;;AAEHC,gB,GAAgB;AACnBC,gBAAY,KADO;AAEnBC,UAAM,MAFa,EAEL;AACdC,aAAS,MAHU;AAInBC,aAAS,IAJU;AAKnBC,UAAM,UALa;AAMnBC,iBAAa,iBANM;AAOnBC,cAAU;AAPS,I;;4BAUPC,a;;;AACZ,2BAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,WAA/B,EAA4CC,IAA5C,EAAkD;AAAA;;AAAA,+HAC3CH,MAD2C,EACnCC,SADmC;;AAEjD,WAAKC,WAAL,GAAmBA,WAAnB;AACA,WAAKC,IAAL,GAAYA,IAAZ;;AAEAd,OAAEe,QAAF,CAAW,MAAKC,KAAhB,EAAuBd,aAAvB,EALiD,CAKV;AACvC,WAAKe,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKC,cAAL,CAAoBC,IAApB,OAAjC;AACA,WAAKH,MAAL,CAAYC,EAAZ,CAAe,eAAf,EAAgC,MAAKG,cAAL,CAAoBD,IAApB,OAAhC;AAPiD;AAQjD;;;;sCAEgB;AAChB,WAAKE,YAAL,CAAkB,SAAlB,EAA6B,qCAA7B,EAAoE,CAApE;AACA;;;oCAEcC,Q,EAAU;AACxB,WAAKC,IAAL,GAAY,EAAZ;AACA,UAAID,YAAYA,SAASE,MAAT,GAAiB,CAA7B,IAAmCF,SAAS,CAAT,EAAYG,UAA/C,IAA6DH,SAAS,CAAT,EAAYG,UAAZ,CAAuBD,MAAvB,GAA+B,CAAhG,EAAmG;AAClG,YAAI,IAAIE,IAAE,CAAV,EAAaA,IAAIJ,SAAS,CAAT,EAAYG,UAAZ,CAAuBD,MAAxC,EAAgDE,GAAhD,EAAqD;AACpD,YAAIC,KAAKL,SAAS,CAAT,EAAYG,UAAZ,CAAuBC,CAAvB,CAAT;AACA,YAAIE,MAAM;AACTtB,eAAOuB,OAAOC,QAAP,CAAgBH,GAAG,CAAH,CAAhB,IAAuB7B,OAAO+B,OAAOC,QAAP,CAAgBH,GAAG,CAAH,CAAhB,CAAP,EAA+BI,MAA/B,CAAsC,qBAAtC,CAAvB,GAAoF,EADlF;AAETxB,sBAAaoB,GAAG,CAAH;AAFJ,SAAV;AAIA,aAAKJ,IAAL,CAAUS,IAAV,CAAeJ,GAAf;AACA;AACD;AACD,WAAKK,QAAL;AACA,WAAKC,MAAL;AACA;;;gCACU9B,O,EAAS;AACnBA,gBAAUA,QAAQ+B,OAAR,CAAgB,IAAhB,EAAsB,OAAtB,EAA+BA,OAA/B,CAAuC,IAAvC,EAA6C,MAA7C,EAAqDA,OAArD,CAA6D,IAA7D,EAAmE,MAAnE,EAA2EA,OAA3E,CAAmF,KAAnF,EAA0F,OAA1F,CAAV;AACA,WAAKC,aAAL,CAAmBhC,OAAnB;AACA;;;oCACcA,O,EAAS;AAAA;;AACvB,UAAI,CAAC,KAAKF,UAAV,EAAsB;AACrB,cAAOmC,OAAOC,MAAP,CAAc,YAAd,EAA4BC,IAA5B,CAAiC,sBAAc;AACrD,eAAKrC,UAAL,GAAkB,IAAIsC,UAAJ,EAAlB;AACA,eAAK9B,MAAL,CAAY+B,MAAZ,CAAmB,YAAM;AACxB,gBAAKL,aAAL,CAAmB,OAAKlC,UAAL,CAAgBgC,MAAhB,CAAuB9B,OAAvB,CAAnB;AACA,SAFD;AAGA,QALM,CAAP;AAMA;;AAED,WAAKgC,aAAL,CAAmB,KAAKlC,UAAL,CAAgBgC,MAAhB,CAAuB9B,OAAvB,CAAnB;AACA;;;mCACasC,E,EAAI;AAAA;;AACjB,UAAI,KAAK3B,KAAL,CAAWV,OAAf,EAAwB;AACvB,WAAIsC,YAAY,EAAhB;AACA,WAAG,KAAKpB,IAAL,CAAUC,MAAV,GAAmB,CAAtB,EAAyB;AAAA,mCAChBE,CADgB;AAEvB,aAAIkB,MAAMF,GAAGP,OAAH,CAAW,gBAAX,EAA6B,UAACU,KAAD,EAAQC,GAAR;AAAA,iBAAgB,OAAKvB,IAAL,CAAUG,CAAV,EAAaoB,IAAIC,IAAJ,EAAb,CAAhB;AAAA,UAA7B,CAAV;AACAJ,sBAAaC,GAAb;AAHuB;;AACxB,aAAI,IAAIlB,IAAI,CAAZ,EAAeA,IAAI,KAAKH,IAAL,CAAUC,MAA7B,EAAqCE,GAArC,EAA0C;AAAA,eAAlCA,CAAkC;AAGzC;AACD,QALD,MAKO;AACNiB,oBAAY,EAAZ;AACA;AACDD,YAAKC,SAAL;AACA;AACD,WAAKP,aAAL,CAAmBM,EAAnB;AACA;;;mCAEaM,I,EAAM;AACnB,UAAI;AACH,YAAK5C,OAAL,GAAe,KAAKS,IAAL,CAAUoC,WAAV,CAAsB,KAAKrC,WAAL,CAAiBuB,OAAjB,CAAyBa,IAAzB,EAA+B,KAAKjC,KAAL,CAAWmC,UAA1C,CAAtB,CAAf;AACA,OAFD,CAEE,OAAOC,CAAP,EAAU;AACXC,eAAQC,GAAR,CAAY,oBAAZ,EAAkCF,CAAlC;AACA,YAAK/C,OAAL,GAAe,KAAKS,IAAL,CAAUoC,WAAV,CAAsBD,IAAtB,CAAf;AACA;AACD;;;gCAEU;AACV,UAAI,KAAKjC,KAAL,CAAWZ,IAAX,KAAoB,UAAxB,EAAoC;AACnC,YAAKmD,cAAL,CAAoB,KAAKvC,KAAL,CAAWX,OAA/B;AACA,OAFD,MAEO,IAAI,KAAKW,KAAL,CAAWZ,IAAX,KAAoB,MAAxB,EAAgC;AACtC,YAAKiC,aAAL,CAAmB,KAAKrB,KAAL,CAAWX,OAA9B;AACA,OAFM,MAEA,IAAI,KAAKW,KAAL,CAAWZ,IAAX,KAAoB,MAAxB,EAAgC;AACtC,YAAKoD,UAAL,CAAgB,KAAKxC,KAAL,CAAWX,OAA3B;AACA,OAFM,MAEA,IAAI,KAAKW,KAAL,CAAWZ,IAAX,KAAoB,UAAxB,EAAoC;AAC1C,YAAKqD,aAAL,CAAmB,KAAKzC,KAAL,CAAWX,OAA9B;AACA;AACD,WAAKqD,kBAAL;AACA;;;0BAEIC,K,EAAOC,I,EAAMC,K,EAAOC,I,EAAM;AAC9BA,WAAK7C,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,YAAY;AACpC,WAAI4C,KAAK9C,KAAL,CAAWZ,IAAX,KAAoB,MAAxB,EAAgC;AAC/BwD,aAAKG,IAAL,CAAU,qBAAV,EAAiCC,GAAjC,CAAqC;AACpC,sBAAaF,KAAK9C,KAAL,CAAWP;AADY,SAArC;AAGA;AACD,OAND;AAOA;;;;KA5FiCX,gB;;;;AA+FnCY,iBAAcuD,WAAd,GAA4B,aAA5B","file":"text_ctrl.js","sourcesContent":["import {\r\n\tMetricsPanelCtrl\r\n} from 'app/plugins/sdk';\r\nimport moment from 'moment';\r\n// import \"./css/text-ctrl.css\";\r\nimport _ from 'lodash';\r\nimport $ from 'jquery';\r\n\r\nvar panelDefaults = {\r\n\tremarkable: 'any',\r\n\tmode: \"text\", // 'html', 'markdown', 'text', 'log-html'\r\n\tcontent: \"输入描述\",\r\n\tisCycle: true,\r\n\ttime: '{{time}}',\r\n\tinformation: '{{information}}',\r\n\tfontSize: '100%'\r\n};\r\n\r\nexport class TextPanelCtrl extends MetricsPanelCtrl {\r\n\tconstructor($scope, $injector, templateSrv, $sce) {\r\n\t\tsuper($scope, $injector);\r\n\t\tthis.templateSrv = templateSrv;\r\n\t\tthis.$sce = $sce;\r\n\r\n\t\t_.defaults(this.panel, panelDefaults); //将panelDefaults属性附加到this.panel上\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t}\r\n\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Options', 'public/plugins/oge_text/editor.html', 2);\r\n\t}\r\n\r\n\tonDataReceived(dataList) {\r\n\t\tthis.data = [];\r\n\t\tif (dataList && dataList.length >0  && dataList[0].datapoints && dataList[0].datapoints.length >0) {\r\n\t\t\tfor(let i=0; i < dataList[0].datapoints.length; i++) {\r\n\t\t\t\tlet da = dataList[0].datapoints[i];\r\n\t\t\t\tlet obj = {\r\n\t\t\t\t\ttime : Number.parseInt(da[1])?moment(Number.parseInt(da[1])).format(\"YYYY-MM-DD HH:mm:ss\"):'',\r\n\t\t\t\t\tinformation: da[0]\r\n\t\t\t\t}\r\n\t\t\t\tthis.data.push(obj);\r\n\t\t\t}\r\n\t\t} \r\n\t\tthis.showData();\r\n\t\tthis.render();\r\n\t}\r\n\trenderText(content) {\r\n\t\tcontent = content.replace(/&/g, '&amp;').replace(/>/g, '&gt;').replace(/</g, '&lt;').replace(/\\n/g, '<br/>');\r\n\t\tthis.updateContent(content);\r\n\t}\r\n\trenderMarkdown(content) {\r\n\t\tif (!this.remarkable) {\r\n\t\t\treturn System.import('remarkable').then(Remarkable => {\r\n\t\t\t\tthis.remarkable = new Remarkable();\r\n\t\t\t\tthis.$scope.$apply(() => {\r\n\t\t\t\t\tthis.updateContent(this.remarkable.render(content));\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tthis.updateContent(this.remarkable.render(content));\r\n\t}\r\n\trenderLogHtml(ht) {\r\n\t\tif (this.panel.isCycle) {\r\n\t\t\tlet newString = ''\r\n\t\t\tif(this.data.length > 0) {\r\n\t\t\t\tfor(let i = 0; i < this.data.length; i++) {\r\n\t\t\t\t\tlet str = ht.replace(/\\{\\{(.*?)\\}\\}/g, (match, key) => this.data[i][key.trim()]);\r\n\t\t\t\t\tnewString += str;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tnewString = \"\";\r\n\t\t\t}\r\n\t\t\tht = newString;\r\n\t\t}\r\n\t\tthis.updateContent(ht);\r\n\t}\r\n\r\n\tupdateContent(html) {\r\n\t\ttry {\r\n\t\t\tthis.content = this.$sce.trustAsHtml(this.templateSrv.replace(html, this.panel.scopedVars));\r\n\t\t} catch (e) {\r\n\t\t\tconsole.log('Text panel error: ', e);\r\n\t\t\tthis.content = this.$sce.trustAsHtml(html);\r\n\t\t}\r\n\t}\r\n\r\n\tshowData() {\r\n\t\tif (this.panel.mode === 'markdown') {\r\n\t\t\tthis.renderMarkdown(this.panel.content);\r\n\t\t} else if (this.panel.mode === 'html') {\r\n\t\t\tthis.updateContent(this.panel.content);\r\n\t\t} else if (this.panel.mode === 'text') {\r\n\t\t\tthis.renderText(this.panel.content);\r\n\t\t} else if (this.panel.mode === 'log-html') {\r\n\t\t\tthis.renderLogHtml(this.panel.content);\r\n\t\t}\r\n\t\tthis.renderingCompleted();\r\n\t}\r\n\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\t\tctrl.events.on('render', function () {\r\n\t\t\tif (ctrl.panel.mode === 'text') {\r\n\t\t\t\telem.find(\".panel-text-content\").css({\r\n\t\t\t\t\t\"font-size\": ctrl.panel.fontSize\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nTextPanelCtrl.templateUrl = 'module.html';"]}