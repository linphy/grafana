{"version":3,"sources":["../src/trace_ctrl.js"],"names":["MetricsPanelCtrl","moment","_","TimeSeries","echarts","$","TraceDrawer","panelDefaults","kksStart","useCacheData","style","pointIndex","weekIndex","circleR","TraceCtrl","$scope","$injector","$rootScope","templateSrv","templateChange","defaults","panel","events","on","onInitEditMode","bind","onDataReceived","dataList","targets","target","changeStart","wave_kks","page_name","dashboard","meta","slug","substring","data","length","console","info","traceCacheData","render","scope","elem","attrs","ctrl","obj","find","html","doDraw","dataType","time","waveTime","datasource","undefined","formData","FormData","i","item","push","append","join","kdmUrl","options","method","linkUser","linkPassword","url","headers","promise","Promise","resolve","reject","getLoginStatus","then","request","body","relogin","error","index","cirlNumber","drawStyle","trace","init","height","draw","templateUrl"],"mappings":"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","file":"trace_ctrl.js","sourcesContent":["import {\n    MetricsPanelCtrl\n}\nfrom 'app/plugins/sdk';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport './css/trace.css!';\nimport TimeSeries from 'app/core/time_series';\nimport echarts from 'vendor/echarts/echarts.min.js';\nimport $ from 'jquery';\nimport TraceDrawer from './trace_drawer.js';\n\nvar panelDefaults = {\n    kksStart: \"EB001HP1\", //KKS索引（枕头坝）\n    useCacheData: true, //默认使用缓存，使用数据插件返回的数据\n    style: {\n        pointIndex: 0, //每周点索引\n        weekIndex: 0, //第几周数据索引\n        circleR: 45 //半径\n    }\n}\n\nexport class TraceCtrl extends MetricsPanelCtrl {\n    constructor($scope, $injector, $rootScope, templateSrv, templateChange) {\n        super($scope, $injector);\n        this.$rootScope = $rootScope;\n        this.templateChange = templateChange;\n        _.defaults(this.panel, panelDefaults);\n\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n        this.events.on('data-received', this.onDataReceived.bind(this));\n\n        this.panel.useCacheData = true;\n    }\n    onInitEditMode() {\n    }\n\n    onDataReceived(dataList) {\n        this.panel.kksStart = this.panel.targets[0].target;\n\n        //1、模板替换\n        this.panel.kksStart = this.templateChange.changeStart(this.panel.kksStart);\n\n        //2、根据kks规则，改变kksStart，主要是再次请求\n        if (this.templateSrv.wave_kks && this.templateSrv.page_name == this.dashboard.meta.slug) {\n            this.panel.kksStart = this.templateSrv.wave_kks[0].substring(0, 8);\n        }\n\n        if (dataList == null || dataList.data == \"error\" || dataList.length == 0) {\n            console.info(\"没有查询到有效数据\");\n            return;\n        }\n        this.traceCacheData = dataList;\n        this.panel.useCacheData = true;\n        this.render();\n    }\n\n    onRender() {\n\n    }\n\n    link(scope, elem, attrs, ctrl) {\n        ctrl.events.on('render', () => {\n            var obj = elem.find('.data-panel');\n            obj.html(\"\");\n            if (ctrl.traceCacheData){\n                this.doDraw(ctrl, obj);\n            }\n        });\n    }\n\n    getWaveData(dataType) {\n\n        var time;\n        if (this.traceCacheData && this.traceCacheData.waveTime) {\n            time = this.traceCacheData.waveTime;\n        }\n        if (!this.datasource && !time)\n            return undefined;\n\n        var formData = new FormData();\n        var targets = [];\n        if (this.panel.targets && this.panel.targets.length > 1) {\n            for (var i = 0; i < this.panel.targets.length; i++) {\n                const item = this.panel.targets[i];\n                targets.push(item.target);\n            }\n        }\n        formData.append(\"kksStart\", targets.length == 0 ? this.panel.kksStart : targets.join(\",\"))\n        formData.append(\"waveTime\", time)\n        formData.append(\"cycleType\", dataType)\n        formData.append(\"kdmUrl\", this.datasource.kdmUrl)\n        var options = {\n            method: 'POST',\n            data: formData\n        };\n\n        //如果连接的数据源地址为KDM Link地址\n        if (this.datasource.linkUser && this.datasource.linkPassword) {\n            options.url = this.datasource.url + '/rest/v1/data-points/wave/getSpace';\n            options.headers = {\n                'Content-Type': undefined,\n            };\n        } else\n            options.url = this.datasource.url + '/wave/getSpace';\n\n        var promise = new Promise((resolve, reject) => {\n\n            this.datasource.getLoginStatus().then(data => {\n\n                this.datasource.request(options).then(body => {\n                    resolve(body.data);\n                }, error => {\n                    this.datasource.relogin(error, options).then(data => resolve(data.body), error => reject(error));\n                });\n            })\n\n        });\n        return promise;\n    }\n    changeStyle(index) {\n        if (index == 4) {\n            this.panel.style.circleR = this.panel.style.circleR + 5; //\n        } else if (index == 5) {\n            this.panel.style.circleR = this.panel.style.circleR - 5; //缩小\n            if (this.panel.style.circleR <= 5) {\n                this.panel.style.circleR = 5; //最小\n            }\n        }\n        this.panel.useCacheData = true;\n        this.render();\n    }\n    doDraw(ctrl, obj) {\n        //1、处理边缘样式 ： 每周点索引\n        if (ctrl.panel.style.pointIndex == -1) {\n            ctrl.panel.style.pointIndex = 255; //数据长度固定256\n        }\n        if (ctrl.panel.style.pointIndex == 256) {\n            ctrl.panel.style.pointIndex = 0; //数据长度固定256\n        }\n\n        //2、处理边缘样式 ： 周索引\n        var cirlNumber = ctrl.traceCacheData.length;\n        if (ctrl.panel.style.weekIndex == -1) {\n            ctrl.panel.style.weekIndex = cirlNumber - 1;\n        }\n        if (ctrl.panel.style.weekIndex == cirlNumber) {\n            ctrl.panel.style.weekIndex = 0;\n        }\n\n        //3、绘图\n        ctrl.traceCacheData.drawStyle = ctrl.panel.style;\n\n        var trace = new TraceDrawer();\n        trace.init(obj[0], ctrl.height);\n\n        \n        trace.draw(ctrl.traceCacheData, ctrl.traceCacheData.drawStyle, obj[0]);\n        // ctrl.panel.useCacheData = false;\n    }\n}\n\nTraceCtrl.templateUrl = 'module.html';\n"]}