{"version":3,"sources":["../../src/tree_ctrl.js"],"names":["OgeAlertMetricsPanelCtrl","moment","_","TimeSeries","echarts","$","panelDefaults","showLevel","layout","width","height","chart","name","show","treeDataDefault","kks","treeDataStr","color","colorId","warnType","breadcrumbs","tooltip","fontSize","topPassLevel","datasourceType","RectangularTreeCtrl","$scope","$injector","$rootScope","backendSrv","variableSrv","templateChange","panel","linkes","push","type","variables","JSON","stringify","defaults","events","on","onDataReceived","bind","onInitEditMode","onDataError","dataList","data","datasource","render","err","console","info","addEditorTab","kksArr","s","Array","length","join","ajax","url","async","success","result","RTDataSets","i","rtdata","RTDataValues","kksCode","value","index","splice","scope","elem","attrs","ctrl","getOption","colorArr","title","subtext","left","trigger","series","breadcrumb","label","normal","textStyle","visibleMin","top","nodeClick","roam","leafDepth","levels","colorMappingBy","itemStyle","borderColor","borderWidth","gapWidth","lable","borderColorSaturation","getKKS","tempData","children","addVariableToPath","treeData","params","templink","link","target","indexOf","charAt","oge_variable","current","undefined","warn","obj","find","css","myChart","init","parseJSON","jsonData","map","extend","getDataAlert","then","alertArray","res","getFormatData","setOption","searchAlertInfoByKKSCode","changeStart","kpi_id","code","alertInfo","remove","alert","getAlertStyleByAlertTag","tag","getAlertLevelColor","ogeAlertColorValue","kksMap","parentJsonData","isTop","topInd","familyLevel","initData","levelTag","level","idl","alert_level","exts","showData","Number","toFixed","getAlertLevelName","isAlert","setColorStyleToTree","childAlert","idLArr","split","strLa","j","eval","styleItem","changeTargets","str","kksCodeStr","getOneSaitDataValue","kksString","method","targets","kdm","dataType","contentType","Alarm","Promise","resolve","range","from","toDate","getTime","to","kpi_alerts","queryStr","callback","linkType","val","linkDashboard","linkUrl","trim","search","query","hits","dashboard","uri","templateUrl"],"mappings":"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","file":"tree_ctrl.js","sourcesContent":["import {\r\n\tOgeAlertMetricsPanelCtrl\r\n} from 'app/plugins/sdk';\r\nimport moment from 'moment';\r\nimport _ from 'lodash';\r\nimport TimeSeries from 'app/core/time_series';\r\nimport './css/clock-panel.css!';\r\nimport echarts from 'vendor/echarts/echarts.min.js';\r\nimport $ from 'jquery';\r\n\r\nvar panelDefaults = {\r\n\tshowLevel: 1, //显示层级\r\n\tlayout: { //相对于panel的比例\r\n\t\twidth: '99%',\r\n\t\theight: '96%'\r\n\t},\r\n\tchart: {\r\n\t\tname: 'XX矩形树',\r\n\t\tshow: false\r\n\t},\r\n\ttreeDataDefault: [{\r\n\t\tname: \"一号机组\",\r\n\t\tkks: ''\r\n\t}],\r\n\ttreeDataStr: '',\r\n\tcolor: [{\r\n\t\tcolor: '#2f4554'\r\n\t}],\r\n\tcolorId: [],\r\n\twarnType: ['子级', 'kks'],\r\n\tbreadcrumbs: false,\r\n\ttooltip: false,\r\n\tfontSize:14,\r\n\t// topShowChildrensAlert:false,\r\n\ttopPassLevel: []\r\n};\r\nvar datasourceType = \"\";\r\n\r\nexport class RectangularTreeCtrl extends OgeAlertMetricsPanelCtrl {\r\n\tconstructor($scope, $injector, $rootScope, backendSrv, variableSrv, templateChange) {\r\n\t\tsuper($scope, $injector);\r\n\t\tthis.$rootScope = $rootScope;\r\n\t\tthis.backendSrv = backendSrv;\r\n\t\tthis.templateChange = templateChange;\r\n\t\tthis.panel.linkes = [];\r\n\t\tthis.panel.linkes.push({\r\n\t\t\ttype: 'dashboard'\r\n\t\t});\r\n\t\tthis.variables = variableSrv.variables;\r\n\t\tif (panelDefaults.treeDataStr == '') {\r\n\t\t\tpanelDefaults.treeDataStr = JSON.stringify(panelDefaults.treeDataDefault, false, 4);\r\n\t\t}\r\n\t\t_.defaults(this.panel, panelDefaults);\r\n\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-error', this.onDataError.bind(this));\r\n\t}\r\n\r\n\tonDataReceived(dataList) {\r\n\t\t// if (!this.datasource.kdmUrl) {\r\n\t\t// \treturn;\r\n\t\t// }\r\n\t\tthis.data = dataList;\r\n\t\tdatasourceType = this.datasource.type;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tonDataError(err) {\r\n\t\tconsole.info(\"error...\");\r\n\t}\r\n\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Options', 'public/plugins/rectangular-tree-panel/editor.html', 2);\r\n\t\tthis.addEditorTab('Data Bind', 'public/plugins/rectangular-tree-panel/databind.html', 3);\r\n\t}\r\n\r\n\tgetDataMap(kksArr) {\r\n\t\tvar s = new Array(kksArr.length);\r\n\t\tvar kks = kksArr.join(\",\");\r\n\t\t$.ajax({\r\n\t\t\ttype: 'GET',\r\n\t\t\turl: this.datasource.url + '/kdmService/rest/1.0/kksData?method=getRTDataSnapshot&kksCodes=' + kks,\r\n\t\t\tasync: false,\r\n\t\t\tsuccess: function success (result) {\r\n\t\t\t\tif(result !== null && result.RTDataSets.length !== 0){\r\n\t\t\t\t\tfor(let i;i < result.RTDataSets.length ;i++){\r\n\t\t\t\t\t\tlet rtdata=result.RTDataSets[i];\r\n\t\t\t\t\t\tif(rtdata.RTDataValues == null || rtdata.RTDataValues.length == 0){\r\n\t\t\t\t\t\t\ts[i] = {'key' : rtdata.kksCode, 'value': 'N/A'};\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\ts[i] = {'key' : rtdata.kksCode, 'value': rtdata.RTDataValues[0].value + ''};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\ts = result;\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn s;\r\n\t}\r\n\r\n\taddElement() {\r\n\t\tthis.panel.color.push({\r\n\t\t\tcolor: '#fff'\r\n\t\t});\r\n\t\tthis.render();\r\n\t}\r\n\tdropElement(index) {\r\n\t\tthis.panel.color.splice(index, 1);\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\t\tfunction getOption(data) {\r\n\t\t\tvar colorArr = [];\r\n\t\t\tfor (var i = 0; i < ctrl.panel.color.length; i++) {\r\n\t\t\t\tcolorArr.push(ctrl.panel.color[i].color)\r\n\t\t\t};\r\n\r\n\t\t\treturn {\r\n\t\t\t\ttitle: {\r\n\t\t\t\t\tsubtext: '',\r\n\t\t\t\t\tleft: 'leafDepth',\r\n\t\t\t\t\tshow: false\r\n\t\t\t\t},\r\n\t\t\t\ttooltip: {\r\n\t\t\t\t\tshow: ctrl.panel.tooltip,\r\n\t\t\t\ttrigger: 'none',\r\n\t\t\t\t},\r\n\t\t\t\tcolor: colorArr,\r\n\t\t\t\tseries: [{\r\n\t\t\t\t\tname: ctrl.panel.chart.name,\r\n\t\t\t\t\ttype: 'treemap',\r\n\t\t\t\t\tbreadcrumb: {\r\n\t\t\t\t\t\tshow: ctrl.panel.breadcrumbs,\r\n\t\t\t\t\t},\r\n\r\n\t\t\t\t\tlabel: {\r\n\t\t\t\t\t\tnormal:{\r\n\t\t\t\t\t\t\ttextStyle: {\r\n\t\t\t\t\t\t\t\tfontSize:ctrl.panel.fontSize,\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t\tvisibleMin: 300,\r\n\t\t\t\t\ttop: 'top',\r\n\t\t\t\t\t//是否显示路径\r\n\t\t\t\t\twidth: ctrl.panel.layout.width,\r\n\t\t\t\t\theight: ctrl.panel.layout.height,\r\n\t\t\t\t\tnodeClick: 'link', //默认zoomToNode点击节点后缩放到节点，link进行超链接跳转，配合silent使用\r\n\t\t\t\t\t//silent:true, //不响应鼠标点击事件\r\n\t\t\t\t\troam: false, //是否开启拖拽漫游（移动和缩放）\r\n\t\t\t\t\tdata: data,\r\n\t\t\t\t\tleafDepth: ctrl.panel.showLevel,\r\n\t\t\t\t\tlevels: [{\r\n\t\t\t\t\t\tcolor: colorArr,\r\n\t\t\t\t\t\tcolorMappingBy: 'index',\r\n\t\t\t\t\t\titemStyle: {\r\n\t\t\t\t\t\t\tnormal: {\r\n\t\t\t\t\t\t\t\tborderColor: '#555',\r\n\t\t\t\t\t\t\t\tborderWidth: 0,\r\n\t\t\t\t\t\t\t\tgapWidth: 2\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\tcolor: colorArr,\r\n\t\t\t\t\t\tlable: {\r\n\t\t\t\t\t\t\tnormal: {\r\n\t\t\t\t\t\t\t\tfontSize: 26\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\titemStyle: {\r\n\t\t\t\t\t\t\tnormal: {\r\n\t\t\t\t\t\t\t\tborderColorSaturation: 0,\r\n\t\t\t\t\t\t\t\tgapWidth: 1,\r\n\t\t\t\t\t\t\t\tborderWidth: 1\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\tcolor: colorArr,\r\n\t\t\t\t\t\titemStyle: {\r\n\t\t\t\t\t\t\tnormal: {\r\n\t\t\t\t\t\t\t\tborderColorSaturation: 0,\r\n\t\t\t\t\t\t\t\tgapWidth: 1\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\tcolor: colorArr,\r\n\t\t\t\t\t\titemStyle: {\r\n\t\t\t\t\t\t\tnormal: {\r\n\t\t\t\t\t\t\t\tborderColorSaturation: 0,\r\n\t\t\t\t\t\t\t\tgapWidth: 1\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}]\r\n\t\t\t\t}]\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tfunction getKKS(kksArr, tempData) {\r\n\t\t\tfor (var i = 0; i < tempData.length; i++) {\r\n\t\t\t\tif (tempData[i].kks != null && tempData[i].kks != '') {\r\n\t\t\t\t\tkksArr.push(tempData[i].kks);\r\n\t\t\t\t}\r\n\t\t\t\tif (tempData[i].children != null) {\r\n\t\t\t\t\tgetKKS(kksArr, tempData[i].children);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction addVariableToPath(treeData, params) {\r\n\t\t\tif (treeData != null && treeData.length > 0) {\r\n\t\t\t\tfor (var i = treeData.length - 1; i >= 0; i--) {\r\n\t\t\t\t\tvar templink = treeData[i].link;\r\n\t\t\t\t\ttreeData[i].target = \"_self\";\r\n\t\t\t\t\tif (templink != null && templink !== '') {\r\n\t\t\t\t\t\tif (templink.indexOf('?') >= 0) {\r\n\t\t\t\t\t\t\tif (templink.charAt(templink.length-1) == '?') {\r\n\t\t\t\t\t\t\t\ttreeData[i].link = templink + params;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\ttreeData[i].link = templink + '&' + params;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttreeData[i].link = templink + '?' + params;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (treeData[i].children != null) {\r\n\t\t\t\t\t\taddVariableToPath(treeData[i].children, params);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\tctrl.events.on('render', function() {\r\n\t\t\t//编写默认参数\r\n\t\t\tvar oge_variable = ctrl.variables;\r\n\t\t\tvar params = '';\r\n\t\t\tif (oge_variable != null && oge_variable.length > 0) {\r\n\t\t\t\tfor (var i = 0; i < oge_variable.length; i++) {\r\n\t\t\t\t\tif (oge_variable[i].type === 'adhoc') continue;\r\n\t\t\t\t\tif (i > 0) {\r\n\t\t\t\t\t\tparams += '&';\r\n\t\t\t\t\t}\r\n\t\t\t\t\tparams += 'var-' + oge_variable[i].name + '=' + oge_variable[i].current.value;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (ctrl.datasource == undefined || ctrl.datasource.url == undefined) {\r\n\t\t\t\tconsole.warn(\"必须使用kdm数据源\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar obj = elem.find('.tree-panel');\r\n\t\t\tobj.css(\"height\", ctrl.height + \"px\")\r\n\t\t\tvar myChart = echarts.init(obj[0]);\r\n\r\n\t\t\t//获取保存的字符串，转变成json对象\r\n\t\t\tvar treeData = $.parseJSON(ctrl.panel.treeDataStr);\r\n\t\t\taddVariableToPath(treeData, params);\r\n\t\t\tvar jsonData = $.map(treeData, function(obj) {\r\n\t\t\t\treturn $.extend(true, {}, obj); //返回对象的深拷贝\r\n\t\t\t});\r\n\r\n\t\t\t//根据json，获取所有的kks,包括children中的\r\n\t\t\tvar kksArr = [];\r\n\t\t\tgetKKS(kksArr, jsonData);\r\n\t\t\t//查找kks对应的数据\r\n\t\t\tctrl.getDataAlert(kksArr).then(res=> {\r\n\t\t\t\tlet alertArray;\r\n\t\t\t\tif(res && res.data) {\r\n\t\t\t\t\talertArray =  res.data;\r\n\t\t\t\t} else {\r\n\t\t\t\t\talertArray =  res;\r\n\t\t\t\t}\r\n\t\t\t\t//处理json，变成chart所需要的格式\r\n\t\t\t\tgetFormatData(jsonData, alertArray, null, true, 0, 0, null);\r\n\r\n\t\t\t\tmyChart.setOption(getOption(jsonData));\r\n\t\t\t});\r\n\t\t\t\r\n\t\t});\r\n\r\n\t\t//autor  dingzai\r\n\t\tfunction searchAlertInfoByKKSCode(kksCode, alertArray) {\r\n\t\t\tvar kksCode = ctrl.templateChange.changeStart(kksCode); //真实的请求的kks\r\n\t\t\tif(alertArray != null){\r\n\t\t\t\tfor (let i = alertArray.length-1; i >= 0; i--) {\r\n\t\t\t\t\tif (kksCode == alertArray[i].kpi_id || kksCode == alertArray[i].code) {\r\n\t\t\t\t\t\tlet alertInfo=alertArray[i];\r\n\t\t\t\t\t\t_.remove(alertArray,function(alert){\r\n\t\t\t\t\t\t\treturn alert.kpi_id == kksCode || alert.code == kksCode;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\treturn alertInfo;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\t//根据tag获取相应的对象 1代表正常 2代表警告 3代表报警\r\n\t\tfunction getAlertStyleByAlertTag(tag) {\r\n\t\t\tvar result = ctrl.getAlertLevelColor(tag);\r\n\t\t\tif (ctrl.ogeAlertColorValue) {\r\n\t\t\t\tvar label = {\r\n\t\t\t\t\tnormal: {\r\n\t\t\t\t\t\ttextStyle: {\r\n\t\t\t\t\t\t\tcolor: result\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn label;\r\n\t\t\t} else {\r\n\t\t\t\tvar itemStyle = {\r\n\t\t\t\t\tnormal: {\r\n\t\t\t\t\t\tcolor: result\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\treturn itemStyle;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//获取提交至chart的数据\r\n\t\t//处理数据，使之成为符合char所需要的模板 \r\n\t\t//tempData是JSON样式  \r\n\t\t//kksMap是查询的告警结果,\r\n\t\t//isTop判断是否是一级，只有用到报警的时候有用\r\n\t\t//topInd是一级的下标\r\n\t\t//familyLevel层级，当前到第几层\r\n\t\tfunction getFormatData(tempData, kksMap, parentJsonData, isTop, topInd, familyLevel, initData) {\r\n\t\t\tif (isTop) {\r\n\t\t\t\tinitData = tempData;\r\n\t\t\t}\r\n\t\t\tfor (var i = 0; i < tempData.length; i++) {\r\n\t\t\t\tvar levelTag = 1;\r\n\t\t\t\t//设置默认值\r\n\t\t\t\ttempData[i].value = levelTag;\r\n\t\t\t\ttempData[i].level = levelTag;\r\n\t\t\t\ttempData[i].idl = parentJsonData?(parentJsonData.idl+'-'+i):(isTop?i+'':'');\r\n\t\t\t\tif (tempData[i].kks != null) {\r\n\t\t\t\t\tif (kksMap != null) {\r\n\t\t\t\t\t\tvar value = \"\";\r\n\t\t\t\t\t\tvar alertInfo = searchAlertInfoByKKSCode(tempData[i].kks, kksMap);\r\n\t\t\t\t\t\tif (alertInfo == null || alertInfo == undefined || (datasourceType==\"oge-kdm\" && alertInfo.value==null)||(datasourceType!==\"oge-kdm\" && alertInfo.alert_level==null)) {\r\n\t\t\t\t\t\t\talertInfo = {\r\n\t\t\t\t\t\t\t\t\"kpi_id\": tempData[i].kks,\r\n\t\t\t\t\t\t\t\t\"alert_level\": 0,\r\n\t\t\t\t\t\t\t\t\"value\": \"\"\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tif(datasourceType==\"oge-kdm\") {\r\n\t\t\t\t\t\t\t\talertInfo = {\r\n\t\t\t\t\t\t\t\t\t\"kpi_id\": tempData[i].kks,\r\n\t\t\t\t\t\t\t\t\t\"alert_level\": alertInfo.value,\r\n\t\t\t\t\t\t\t\t\t\"value\": alertInfo.exts&&alertInfo.exts['报警字段值']?alertInfo.exts['报警字段值']:alertInfo.value\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// 自带的服务 ctrl.getAlertLevelName 通过级别获取显示的报警标识名称\r\n\t\t\t\t\t\tif (tempData[i].showData == true && alertInfo.value!==\"\") value = Number(alertInfo.value.toFixed(2)) + \"  \" + ctrl.getAlertLevelName(alertInfo.alert_level);\r\n\t\t\t\t\t\t//如果设置为报警才显示报警颜色 isAlert 表示 kks报警\r\n\t\t\t\t\t\ttempData[i].value = 1; //更新值\r\n\t\t\t\t\t\ttempData[i].level = 1; //定义级别标识，便于后面穷举判断\r\n\t\t\t\t\t\tif (tempData[i].isAlert == true) {\r\n\t\t\t\t\t\t\tlevelTag = alertInfo.alert_level;\r\n\t\t\t\t\t\t\tif(isTop) {\r\n\t\t\t\t\t\t\t\ttopInd = i;\r\n\t\t\t\t\t\t\t\tctrl.panel.topPassLevel[topInd] = levelTag;\r\n\t\t\t\t\t\t\t\tfamilyLevel = 0;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tsetColorStyleToTree(tempData[i], alertInfo.alert_level);\r\n\t\t\t\t\t\t\t//父节点设置为子级报警且父节点的报警级别小于子级，才对父节点的样式进行变化\r\n\t\t\t\t\t\t\tif (parentJsonData != null && parentJsonData.childAlert == true && parentJsonData.level < levelTag && ctrl.panel.topPassLevel[topInd]<levelTag) {\r\n\t\t\t\t\t\t\t\t//记录最高报警级别\r\n\t\t\t\t\t\t\t\tctrl.panel.topPassLevel[topInd] = levelTag;\r\n\t\t\t\t\t\t\t\tlet idLArr = tempData[i].idl.split('-');\r\n\t\t\t\t\t\t\t\tlet strLa = \"initData[idLArr[0]]\";\r\n\t\t\t\t\t\t\t\tfor (let j=1; j<idLArr.length; j++) {\r\n\t\t\t\t\t\t\t\t\tsetColorStyleToTree(eval(strLa), levelTag);\r\n\t\t\t\t\t\t\t\t\tstrLa += \".children[idLArr[\"+j+\"]]\";\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (tempData[i].showData == true && value == \"\") {\r\n\t\t\t\t\t\t\tvalue = \"N/A\" + \"  \" + ctrl.getAlertLevelName(1);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\ttempData[i].name += \" \" + value;\r\n\t\t\t\t\t\ttempData[i].tag = tempData[i].kks;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//提高效率,可以去掉重复判断的问题\r\n\t\t\t\t\tdelete tempData[i].kks\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (tempData[i].children != null) {\r\n\t\t\t\t\t//如果当前级有子级 且设置报警类型为子级， 才会联动显示报警信息\r\n\t\t\t\t\tif (tempData[i].childAlert == 1) {\r\n\t\t\t\t\t\tgetFormatData(tempData[i].children, kksMap, tempData[i], false, topInd, familyLevel++, initData);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tgetFormatData(tempData[i].children, kksMap, null, false, topInd, familyLevel++, initData);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//设置树节点的样式 data: 要修改的某个节点， level： 颜色级别\r\n\t\tfunction setColorStyleToTree(data, level) {\r\n\t\t\tvar styleItem = getAlertStyleByAlertTag(level);\r\n\t\t\t//显示方式分为 字体颜色，和背景颜色，默认为背景颜色\r\n\t\t\tif (ctrl.ogeAlertColorValue) {\r\n\t\t\t\t//data.label 设置字体的\r\n\t\t\t\tdata.label = styleItem;\r\n\t\t\t} else {\r\n\t\t\t\t//itemStyle 设置背景相关样式的\r\n\t\t\t\tdata.itemStyle = styleItem;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetDataAlert(kksArr) {\r\n\t\tthis.templateChange.changeTargets(kksArr);\r\n\t\tvar s;\r\n\t\tvar jsonData;\r\n\t\tif (datasourceType == 'oge-kxm-restalarm' || datasourceType == 'oge-kxm-ontologies') {\r\n\t\t\tlet str = '';\r\n\t\t\tlet kksCodeStr = 'c.KpiAlertLatest.kpiId = \"';\r\n\t\t\tfor (var j = 0; j < kksArr.length; j++) {\r\n\t\t\t\tif (j === 0) {\r\n\t\t\t\t\tkksCodeStr += (kksArr[0]+'\"');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tkksCodeStr += (' OR c.KpiAlertLatest.kpiId = \"' + kksArr[j]+'\"');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tstr = \"select KpiAlertLatest.alertLevel as alert_level, KpiAlertLatest.datetime as datetime, KpiAlertLatest.value as value, KpiAlertLatest.kpiId as kpi_id from KpiAlertLatest as c where \"+kksCodeStr;\r\n\t\t\treturn this.datasource.getOneSaitDataValue('KpiAlertLatest', str);\r\n\t\t} else if(datasourceType == 'oge-kdm'){\r\n\t\t\tvar kksString = kksArr.join(',');\r\n\t\t\tvar method = \"getLatestAlarm\";\r\n\t\t\tif(this.panel.targets && this.panel.targets[0] && this.panel.targets[0].kdm ) {\r\n\t\t\t\tmethod = this.panel.targets[0].kdm.dataType==1?\"getLatestAlarm\":\"getHistoryAlarm\";\r\n\t\t\t}\r\n\t\t\t$.ajax({\r\n\t\t\t\ttype: 'GET',\r\n\t\t\t\turl: this.datasource.url + '/kxmData?kksCodes='+kksString+'&method='+method,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tasync: false,\r\n\t\t\t\tcontentType: 'application/json',\r\n\t\t\t\tsuccess: function success(result) {\r\n\t\t\t\t\ts = result.Alarm;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn Promise.resolve(s);\r\n\t\t} else {\r\n\t\t\tif(this.panel.kdm.dataType == 1){\r\n\t\t\t\tjsonData={\"_postalerts_last\" : {\"kpi_ids\" : kksArr}};\r\n\t\t\t}else{\r\n\t\t\t\tjsonData={\"_postalerts\" : {\"kpi_ids\" : kksArr,\"start_time\" : this.range.from.toDate().getTime(),\"end_time\" : this.range.to.toDate().getTime()}};\r\n\t\t\t}\r\n\t\t\t$.ajax({\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\turl: this.datasource.url + '/services/kpi_datas/alerts' + (this.panel.kdm.dataType == 1? '/last':'') ,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: JSON.stringify(jsonData),\r\n\t\t\t\tasync: false,\r\n\t\t\t\tcontentType: 'application/json',\r\n\t\t\t\tsuccess: function success(result) {\r\n\t\t\t\t\ts = result.kpi_alerts.alert;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn Promise.resolve(s);\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\tsearchDashboards(queryStr, callback) {};\r\n\r\n\tdashboardChanged() {\r\n\t\tvar linkType = $('#linkType').val() ;\r\n\t\tvar linkDashboard = $('#linkDashboard').val();\r\n\r\n\r\n\r\n\t\tvar linkUrl = $('#linkUrl').val();\r\n\t\tif (linkType === 'absolute') {\r\n\t\t\t$(\"#link\").val(linkUrl ? linkUrl.trim() : \"\");\r\n\t\t\t$(\"#dashboardName\").val($(\"#link\").val());\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\r\n\t\tthis.backendSrv.search({\t\r\n\t\t\tquery: linkDashboard\r\n\t\t}).then(function(hits) {\r\n\t\t\tvar dashboard = _.find(hits, {\r\n\t\t\t\ttitle: linkDashboard\r\n\t\t\t});\r\n\r\n\t\t\tif (dashboard) {\r\n\t\t\t\t$(\"#link\").val('dashboard/' + dashboard.uri);\r\n\t\t\t\tlink.title = dashboard.title;\r\n\t\t\t\t$(\"#dashboardName\").val(dashboard.title);\r\n\t\t\t} else {\r\n\t\t\t\t$(\"#link\").val('');\r\n\t\t\t\t$(\"#dashboardName\").val('');\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n}\r\n\r\nRectangularTreeCtrl.templateUrl = 'module.html';"]}