{"version":3,"sources":["../../src/table_ctrl.js"],"names":["OgeAlertMetricsPanelCtrl","moment","_","$","panelOptionDefaults","metrics","includeVars","isShowKKSName","isShowTime","isShowUnit","isShowValue","firstColumnText","secondColumnText","thirdColumnText","fourColumnText","alarmStyle","colors","fontFamily","fontSize","fontStyle","dataPrecise","TablePanelCtrl","$scope","$injector","$rootScope","backendSrv","linkSrv","searchDashboards","queryStr","callback","search","query","then","hits","dashboards","map","dash","title","defaults","panel","options","events","on","onInitEditMode","bind","onDataReceived","onRender","addEditorTab","dataList","tmpMetrics","isEmpty","i","length","item","refId","link","type","url","dashboard","dashUri","unit","threshold","data","render","dat","value","time","datapoints","toFixed","Number","parseInt","format","ogeAlertEnabled","alarm","color","getAlertLevelColor","level","scope","elem","attrs","ctrl","pageCount","getTableHeight","panelHeight","height","rootElem","find","css","linkInfo","getPanelLinkAnchorInfo","scopedVars","href","reverse","uri","templateUrl"],"mappings":"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","file":"table_ctrl.js","sourcesContent":["import {\r\n\tOgeAlertMetricsPanelCtrl\r\n}\r\nfrom 'app/plugins/sdk';\r\nimport moment from 'moment';\r\nimport _ from 'lodash';\r\nimport './css/clock-panel.css!';\r\nimport $ from 'jquery';\r\n\r\nvar panelOptionDefaults = {\r\n\tmetrics: {},\r\n\tincludeVars: true,\r\n\r\n\tisShowKKSName: true,\r\n\tisShowTime: true,\r\n\tisShowUnit: false,\r\n\tisShowValue: true,\r\n\tfirstColumnText: '名称',\r\n\tsecondColumnText: '时间',\r\n\tthirdColumnText: '值',\r\n\tfourColumnText: '单位',\r\n\talarmStyle: 'none',\r\n\tcolors: [\"rgba(50, 172, 45, 0.97)\", \"rgba(237, 129, 40, 0.89)\",\r\n\t\t\"rgba(245, 54, 54, 0.9)\"\r\n\t],\r\n\r\n\tfontFamily: '微软雅黑',\r\n\tfontSize: '100%',\r\n\tfontStyle: 'normal',\r\n\r\n\tdataPrecise: 2,\r\n};\r\n\r\nexport class TablePanelCtrl extends OgeAlertMetricsPanelCtrl {\r\n\r\n\t/** @ngInject */\r\n\tconstructor($scope, $injector, $rootScope, backendSrv, linkSrv) {\r\n\t\tsuper($scope, $injector);\r\n\t\t$scope.searchDashboards = function (queryStr, callback) {\r\n\t\t\tthis.backendSrv.search({\r\n\t\t\t\tquery: queryStr\r\n\t\t\t}).then(function (hits) {\r\n\t\t\t\tvar dashboards = _.map(hits, function (dash) {\r\n\t\t\t\t\treturn dash.title;\r\n\t\t\t\t});\r\n\t\t\t\tcallback(dashboards);\r\n\t\t\t});\r\n\t\t};\r\n\t\tthis.backendSrv = backendSrv;\r\n\t\tthis.linkSrv = linkSrv;\r\n\r\n\t\t_.defaults(this.panel, {\r\n\t\t\toptions: {}\r\n\t\t}); //将panelDefaults属性附加到this.panel上\r\n\t\t_.defaults(this.panel.options, panelOptionDefaults);\r\n\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t\tthis.events.on('render', this.onRender.bind(this));\r\n\t}\r\n\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Options',\r\n\t\t\t'public/plugins/oge_table_link_v2/editor.html', 2);\r\n\t}\r\n\r\n\tonDataReceived(dataList) {\r\n\t\tvar tmpMetrics = this.panel.options.metrics;\r\n\t\tthis.panel.options.metrics = {};\r\n\r\n\t\tif (_.isEmpty(dataList)) return;\r\n\r\n\t\tfor (var i = 0; i < dataList.length; i++) {\r\n\t\t\tvar item = dataList[i];\r\n\t\t\t//zy：当数据源没有refid时，让数据的下标i作为数据的refId \r\n\t\t\titem.refId=i;\r\n\t\t\tthis.panel.options.metrics[item.refId] = tmpMetrics[item.refId] || {\r\n\t\t\t\tlink: {\r\n\t\t\t\t\ttype: 'none',\r\n\t\t\t\t\turl: null,\r\n\t\t\t\t\tdashboard: null,\r\n\t\t\t\t\tdashUri: null\r\n\t\t\t\t},\r\n\t\t\t\tunit: null,\r\n\t\t\t\tthreshold: '',\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tthis.data = dataList;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tonRender() {\r\n\t\tif (_.isEmpty(this.data)) return; // 数据为空，则跳出\r\n\r\n\t\tfor (var i = 0; i < this.data.length; i++) {\r\n\t\t\tvar dat = this.data[i];\r\n\r\n\t\t\t// 设置 Value 和 Time\r\n\t\t\tdat.value = '-';\r\n\t\t\tdat.time = '-';\r\n\t\t\tif (!_.isEmpty(dat.datapoints)) {\r\n\t\t\t\tvar value = dat.datapoints[dat.datapoints.length - 1][0].toFixed(this.panel.options.dataPrecise);\r\n\t\t\t\tif (value !== -9999) dat.value = value;\r\n\r\n\t\t\t\tvar time = dat.datapoints[dat.datapoints.length - 1][1];\r\n\t\t\t\tif (Number.parseInt(time) > 0)\r\n\t\t\t\t\tdat.time = moment(Number.parseInt(time)).format(\"YYYY-MM-DD HH:mm:ss\");\r\n\t\t\t}\r\n\t\t\tif (this.panel.ogeAlertEnabled) {\r\n\t\t\t\tif (dat.alarm == null) {\r\n\t\t\t\t\tcontinue\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdat.color = this.getAlertLevelColor(dat.alarm.level);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\r\n\t\tvar pageCount = 0;\r\n\t\t//table高度\r\n\t\tfunction getTableHeight() {\r\n\t\t\tvar panelHeight = ctrl.height;\r\n\t\t\tif (pageCount > 1) {\r\n\t\t\t\tpanelHeight -= 26;\r\n\t\t\t}\r\n\t\t\treturn panelHeight + 'px';\r\n\t\t}\r\n\t\tctrl.events.on('render', function () {\r\n\t\t\tif (_.isEmpty(ctrl.data)) return;\r\n\r\n\t\t\tvar rootElem = elem.find('.table-panel-scroll'); //表格需要处理高度\r\n\t\t\tpageCount = ctrl.data.length;\r\n\t\t\trootElem.css({\r\n\t\t\t\t'max-height': getTableHeight()\r\n\t\t\t})\r\n\t\t});\r\n\t}\r\n\r\n\tformatLinkHref(link) {\r\n\t\tif (link.type === 'none') {\r\n\t\t\treturn '###';\r\n\t\t}\r\n\r\n\t\tlink.includeVars = this.panel.options.includeVars;\r\n\t\tvar linkInfo = this.linkSrv.getPanelLinkAnchorInfo(link, this.panel.scopedVars);\r\n\t\treturn linkInfo.href;\r\n\t}\r\n\r\n\r\n\tinvertColorOrder() {\r\n\t\tthis.panel.options.colors.reverse()\r\n\t}\r\n\r\n\tdashboardChanged(link) {\r\n\t\tthis.backendSrv.search({\r\n\t\t\tquery: link.dashboard\r\n\t\t}).then(function (hits) {\r\n\t\t\tvar dashboard = _.find(hits, {\r\n\t\t\t\ttitle: link.dashboard\r\n\t\t\t});\r\n\t\t\tif (dashboard) {\r\n\t\t\t\tlink.dashUri = dashboard.uri;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsearchDashboards(queryStr, callback) {\r\n\t\tthis.backendSrv.search({\r\n\t\t\tquery: queryStr\r\n\t\t}).then(function (hits) {\r\n\t\t\tvar dashboards = _.map(hits, function (dash) {\r\n\t\t\t\treturn dash.title;\r\n\t\t\t});\r\n\t\t\tcallback(dashboards);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nTablePanelCtrl.templateUrl = 'module.html';"]}