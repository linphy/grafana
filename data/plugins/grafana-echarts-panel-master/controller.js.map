{"version":3,"sources":["../src/controller.js"],"names":["MetricsPanelCtrl","_","kbn","echarts","DataFormatter","Controller","$scope","$injector","panelDefaults","EchartsOption","IS_UCD","METHODS","ETYPE","url","method","upInterval","esMetric","defaults","panel","dataFormatter","events","on","onDataReceived","bind","onDataError","onInitEditMode","render","refreshData","dataList","data","customizeData","type","setGeohashValues","aggByProvince","refreshed","err","addEditorTab","_this","xmlhttp","window","XMLHttpRequest","ActiveXObject","onreadystatechange","readyState","status","JSON","parse","responseText","open","send","$timeout","grafanaBootData","settings","panels","pluginId","baseUrl","scope","elem","attrs","ctrl","$panelContainer","find","option","echartsData","setHeight","height","row","isString","parseInt","replace","style","myChart","init","setTimeout","resize","callInterval","timeout","result","func","callBack","interval","context","args","arguments","clearInterval","setInterval","apply","clear","eval","setOption","renderingCompleted","templateUrl"],"mappings":"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","file":"controller.js","sourcesContent":["import { MetricsPanelCtrl } from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\n\r\nimport echarts from './libs/echarts.min';\r\nimport './libs/dark';\r\nimport './style.css!';\r\nimport './libs/china.js';\r\n\r\nimport DataFormatter from './data_formatter';\r\n\r\n\r\n\r\nexport class Controller extends MetricsPanelCtrl {\r\n\r\n    constructor($scope, $injector) {\r\n        super($scope, $injector);\r\n\r\n        const panelDefaults = {\r\n            EchartsOption: 'option = {};',\r\n            IS_UCD: false,\r\n            METHODS: ['POST', 'GET'],\r\n            ETYPE: ['line', 'pie', 'map'],\r\n            url: '',\r\n            method: 'POST',\r\n            upInterval: 60000,\r\n            esMetric: 'Count'\r\n        };\r\n\r\n        _.defaults(this.panel, panelDefaults);\r\n\r\n        this.dataFormatter = new DataFormatter(this, kbn);\r\n\r\n        this.events.on('data-received', this.onDataReceived.bind(this));\r\n        this.events.on('data-error', this.onDataError.bind(this));\r\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        this.events.on('panel-initialized', this.render.bind(this));\r\n\r\n        this.refreshData();\r\n    }\r\n\r\n\r\n    onDataReceived(dataList) {\r\n        this.data = this.panel.IS_UCD ? this.customizeData : dataList;\r\n\r\n        if (this.panel.type == 'map') {\r\n            const data  = [];\r\n            this.dataFormatter.setGeohashValues(dataList, data);\r\n            this.data = this.dataFormatter.aggByProvince(data);\r\n        }\r\n\r\n        this.refreshed = true;\r\n        this.render();\r\n        this.refreshed = false;\r\n    }\r\n\r\n\r\n    onDataError(err) {\r\n        this.render();\r\n    }\r\n\r\n\r\n    onInitEditMode() {\r\n        this.addEditorTab('Customize Data', 'public/plugins/grafana-echarts-panel/partials/editor-ds.html', 2);\r\n        this.addEditorTab('Echarts Option', 'public/plugins/grafana-echarts-panel/partials/editor-echarts.html', 3);\r\n    }\r\n\r\n\r\n    refreshData() {\r\n        let _this = this, xmlhttp;\r\n\r\n        if (window.XMLHttpRequest) {\r\n            xmlhttp = new XMLHttpRequest();\r\n        } else {\r\n            xmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\");\r\n        }\r\n\r\n        let data = [];\r\n        xmlhttp.onreadystatechange = function () {\r\n            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {\r\n                _this.customizeData = JSON.parse(xmlhttp.responseText);\r\n                _this.onDataReceived();\r\n            }\r\n        };\r\n\r\n        if (this.panel.IS_UCD) {\r\n            xmlhttp.open(_this.panel.method, _this.panel.url, true);\r\n            xmlhttp.send();\r\n        } else {\r\n            xmlhttp = null;\r\n        }\r\n\r\n        this.$timeout(() => { this.refreshData(); }, _this.panel.upInterval);\r\n    }\r\n\r\n\r\n    getPanelPath() {\r\n        // the system loader preprends publib to the url, add a .. to go back one level\r\n        return '../' + grafanaBootData.settings.panels[this.pluginId].baseUrl + '/';\r\n    }\r\n\r\n\r\n    link(scope, elem, attrs, ctrl) {\r\n        const $panelContainer = elem.find('.echarts_container')[0];\r\n        let option = {}, echartsData = [];\r\n\r\n        ctrl.refreshed = true;\r\n\r\n        function setHeight() {\r\n            let height = ctrl.height || panel.height || ctrl.row.height;\r\n            if (_.isString(height)) {\r\n                height = parseInt(height.replace('px', ''), 10);\r\n            }\r\n\r\n            $panelContainer.style.height = height + 'px';\r\n        }\r\n\r\n        setHeight();\r\n\r\n        let myChart = echarts.init($panelContainer, 'dark');\r\n\r\n        setTimeout(function () {\r\n            myChart.resize();\r\n        }, 1000);\r\n\r\n        var callInterval = function callInterval() {\r\n            var timeout, result;\r\n\r\n            function func(callBack, interval) {\r\n                var context = this; // jshint ignore:line\r\n                var args = arguments;\r\n\r\n                if (timeout) clearInterval(timeout);\r\n\r\n                timeout = setInterval(function () {\r\n                    result = callBack.apply(context, args);\r\n                }, interval);\r\n\r\n                return result;\r\n            }\r\n\r\n            return func;\r\n        }();\r\n\r\n        function render() {\r\n\r\n            if (!myChart) {\r\n                return;\r\n            }\r\n\r\n            setHeight();\r\n            myChart.resize();\r\n\r\n            if (ctrl.refreshed) {\r\n                myChart.clear();\r\n                echartsData = ctrl.data;\r\n\r\n                eval(ctrl.panel.EchartsOption); // jshint ignore:line\r\n\r\n                myChart.setOption(option);\r\n            }\r\n        }\r\n\r\n        this.events.on('render', function () {\r\n            render();\r\n            ctrl.renderingCompleted();\r\n        });\r\n    }\r\n}\r\n\r\nController.templateUrl = 'partials/module.html';\r\n"]}