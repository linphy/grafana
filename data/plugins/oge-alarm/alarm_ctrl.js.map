{"version":3,"sources":["../src/alarm_ctrl.js"],"names":["MetricsPanelCtrl","_","$","panelDefaults","stepLength","speed","delay","alarmNum","dcCodeRules","alarmCodeRules","colors","colorOption","name","value","colorMode","alarmValNames","urls","interval","OgeAlarmCtrl","$scope","$injector","defaults","panel","options","events","on","onInitEditMode","bind","onDataReceived","onRender","addEditorTab","index","splice","render","push","code","reverse","dataList","data","datasource","i","targets","length","datasourceSrv","datasources","url","that","getAlarmData","then","alarmInfors","console","error","sort","a","b","Date","time","getTime","codeMap","Map","alarmInfor","has","get","set","getKksCodes","KKSInfos","clear","kksName","kksCode","promises","getData","method","getAjaxPromise","Promise","all","results","alarmInfos","Alarm","j","catch","reason","log","keys","codes","queryName","orderby","params","header","Array","from","Set","limit","offset","fields","query","URLSearchParams","toString","codeTargets","type","requestUrl","ajax","ctrl","elem","tBodyElem","children","scrollTop","clearInterval","start","setInterval","scrolling","scrollHeight","offsetHeight","clientHeight","setTimeout","map","dcCodeRule","tempCode","tempPQ","tempJz","dcName","substring","Number","content","valName","scope","attrs","isEmpty","dcNameConvert","CO","alermValConvert","rootElem","find","autoScroll","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACIA,4B,kBAAAA,gB;;AAGGC,a;;AACAC,a;;;;;;;;;;;;;;;;;;;;;AAEHC,yB,GAAgB;AAChBC,4BAAY,EADI;AAEhBC,uBAAO,CAFS;AAGhBC,uBAAO,CAHS;AAIhBC,0BAAU,EAJM;AAKhBC,6BAAa,EALG;AAMhBC,gCAAgB,EANA;AAOhBC,wBAAQ,CAAC,yBAAD,EAA4B,0BAA5B,EACJ,wBADI,CAPQ;AAUhBC,6BAAa,CAAC;AACVC,0BAAM,IADI;AAEVC,2BAAO;AAFG,iBAAD,EAGV;AACCD,0BAAM,KADP;AAECC,2BAAO;AAFR,iBAHU,EAMV;AACCD,0BAAM,GADP;AAECC,2BAAO;AAFR,iBANU,EASV;AACCD,0BAAM,GADP;AAECC,2BAAO;AAFR,iBATU,CAVG;AAuBhBC,2BAAW,MAvBK;AAwBhBC,+BAAc,CAAC,EAAD,EAAI,EAAJ,EAAO,EAAP,CAxBE;AAyBhBC,sBAAM,EAzBU;AA0BhBC,0BAAU;AA1BM,a;;oCA4BPC,Y;;;AACT,sCAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA,4IACrBD,MADqB,EACbC,SADa;;AAE3BnB,sBAAEoB,QAAF,CAAW,MAAKC,KAAhB,EAAuB;AACnBC,iCAAS;AADU,qBAAvB;AAGAtB,sBAAEoB,QAAF,CAAW,MAAKC,KAAL,CAAWC,OAAtB,EAA+BpB,aAA/B;;AAEA,0BAAKqB,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKC,cAAL,CAAoBC,IAApB,OAAjC;AACA,0BAAKH,MAAL,CAAYC,EAAZ,CAAe,eAAf,EAAgC,MAAKG,cAAL,CAAoBD,IAApB,OAAhC;AACA,0BAAKH,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,MAAKI,QAAL,CAAcF,IAAd,OAAzB;AAT2B;AAU9B;;;;qDACgB;AACb,6BAAKG,YAAL,CAAkB,SAAlB,EACI,sCADJ,EAC4C,CAD5C;AAEH;;;+CAEUC,K,EAAO;AACd,6BAAKT,KAAL,CAAWC,OAAX,CAAmBf,WAAnB,CAA+BwB,MAA/B,CAAsCD,KAAtC,EAA4C,CAA5C;AACA,6BAAKE,MAAL;AACH;;;8CAES;AACN,6BAAKX,KAAL,CAAWC,OAAX,CAAmBf,WAAnB,CAA+B0B,IAA/B,CAAoC,EAACC,MAAK,EAAN,EAASvB,MAAK,EAAd,EAApC;AACA,6BAAKqB,MAAL;AACH;;;uDAEkB;AACf,6BAAKX,KAAL,CAAWC,OAAX,CAAmBb,MAAnB,CAA0B0B,OAA1B;AACA,6BAAKH,MAAL;AACH;;;mDAEcI,Q,EAAU;AACrB,6BAAKC,IAAL,GAAY,EAAZ;AACA,6BAAKhB,KAAL,CAAWC,OAAX,CAAmBP,IAAnB,GAA0B,EAA1B;AACA,4BAAI,KAAKM,KAAL,CAAWiB,UAAX,IAAyB,aAA7B,EAA4C;AACxC,iCAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAI,KAAKlB,KAAL,CAAWmB,OAAX,CAAmBC,MAAvC,EAA+CF,GAA/C,EAAoD;AAChD,qCAAKlB,KAAL,CAAWC,OAAX,CAAmBP,IAAnB,CAAwBkB,IAAxB,CAA6B,KAAKS,aAAL,CAAmBC,WAAnB,CAA+B,KAAKtB,KAAL,CAAWmB,OAAX,CAAmBD,CAAnB,EAAsBD,UAArD,EAAiEM,GAA9F;AACH;AACJ,yBAJD,MAIO;AACH,iCAAKvB,KAAL,CAAWC,OAAX,CAAmBP,IAAnB,CAAwBkB,IAAxB,CAA6B,KAAKK,UAAL,CAAgBM,GAA7C;AACH;AACD,4BAAI,KAAKvB,KAAL,CAAWC,OAAX,CAAmBP,IAAnB,CAAwB0B,MAAxB,IAAkC,CAAtC,EAAyC;AACrC;AACH;AACD,4BAAII,OAAO,IAAX;AACA;AACA,6BAAKC,YAAL,CAAkB,KAAKzB,KAAL,CAAWC,OAAX,CAAmBP,IAArC,EAA2CgC,IAA3C,CAAgD,UAAUC,WAAV,EAAuB;AACnE,gCAAIA,YAAYP,MAAZ,IAAsB,CAA1B,EAA6B;AACzBQ,wCAAQC,KAAR,CAAc,qBAAd;AACA;AACH,6BAHD,MAGO;AACH;AACAF,4CAAYG,IAAZ,CAAiB,UAAUC,CAAV,EAAYC,CAAZ,EAAe;AAC5B,2CAAO,IAAIC,IAAJ,CAASD,EAAEE,IAAX,EAAiBC,OAAjB,KAA6B,IAAIF,IAAJ,CAASF,EAAEG,IAAX,EAAiBC,OAAjB,EAApC;AACH,iCAFD;AAGA,oCAAIR,YAAYP,MAAZ,GAAqBI,KAAKxB,KAAL,CAAWC,OAAX,CAAmBhB,QAA5C,EAAsD;AAClD0C,gDAAYjB,MAAZ,CAAmBc,KAAKxB,KAAL,CAAWC,OAAX,CAAmBhB,QAAtC;AACH;AACD;AACA,oCAAImD,UAAU,IAAIC,GAAJ,EAAd;AACA,oCAAI3C,OAAO,EAAX;AAVG;AAAA;AAAA;;AAAA;AAWH,yDAAuBiC,WAAvB,8HAAoC;AAAA,4CAA3BW,UAA2B;;AAChC5C,+CAAO,EAAP;AACA,4CAAI0C,QAAQG,GAAR,CAAYD,WAAWf,GAAvB,CAAJ,EAAiC;AAC7B7B,mDAAO0C,QAAQI,GAAR,CAAYF,WAAWf,GAAvB,CAAP;AACA7B,iDAAKkB,IAAL,CAAU0B,WAAWzB,IAArB;AACAuB,oDAAQK,GAAR,CAAYH,WAAWf,GAAvB,EAA2B7B,IAA3B;AACH,yCAJD,MAIO;AACH0C,oDAAQK,GAAR,CAAYH,WAAWf,GAAvB,EAA2B,CAACe,WAAWzB,IAAZ,CAA3B;AACH;AACJ;AApBE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAqBHW,qCAAKkB,WAAL,CAAiBN,OAAjB,EAA0BV,IAA1B,CAA+B,UAAUiB,QAAV,EAAoB;AAC/CP,4CAAQQ,KAAR;AACA,wCAAID,YAAYA,SAASvB,MAAT,GAAkB,CAAlC,EAAqC;AACjC,6CAAK,IAAIF,KAAI,CAAb,EAAgBA,KAAIyB,SAASvB,MAA7B,EAAqCF,IAArC,EAA0C;AACtC,gDAAIyB,SAASzB,EAAT,EAAY2B,OAAZ,IAAuBF,SAASzB,EAAT,EAAY2B,OAAZ,KAAwB,EAAnD,EAAuD;AACnDT,wDAAQK,GAAR,CAAYE,SAASzB,EAAT,EAAY4B,OAAxB,EAAiCH,SAASzB,EAAT,EAAY2B,OAA7C;AACH;AACJ;AALgC;AAAA;AAAA;;AAAA;AAMjC,kEAAuBlB,WAAvB,mIAAoC;AAAA,oDAA3BW,UAA2B;;AAChC,oDAAIF,QAAQG,GAAR,CAAYD,WAAWzB,IAAvB,CAAJ,EAAkC;AAC9ByB,+DAAWhD,IAAX,GAAkB8C,QAAQI,GAAR,CAAYF,WAAWzB,IAAvB,CAAlB;AACH;AACJ;AAVgC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWpC;AACDW,yCAAKR,IAAL,GAAYW,WAAZ;AACAH,yCAAKb,MAAL;AACH,iCAhBD;AAiBH;AACJ,yBA3CD;AA4CH;;;iDAEYjB,I,EAAM;AACf,4BAAIqD,WAAW,EAAf;AACA,6BAAK,IAAI7B,IAAI,CAAb,EAAgBA,IAAIxB,KAAK0B,MAAzB,EAAiCF,GAAjC,EAAsC;AAClC,gCAAI8B,UAAU;AACVC,wCAAQ,kBADE;AAEVhE,0CAAU,KAAKe,KAAL,CAAWC,OAAX,CAAmBhB,QAFnB;AAGVE,gDAAgB,KAAKa,KAAL,CAAWC,OAAX,CAAmBd;AAHzB,6BAAd;AAKA4D,qCAAS7B,CAAT,IAAc,KAAKgC,cAAL,CAAoB,KAApB,EAA2BF,OAA3B,EAAmCtD,KAAKwB,CAAL,IAAQ,UAA3C,CAAd;AACH;AACD,+BAAOiC,QAAQC,GAAR,CAAYL,QAAZ,EACFrB,IADE,CACG,UAAU2B,OAAV,EAAmB;AACrB,gCAAIC,aAAa,EAAjB;AACA,gCAAID,WAAWA,QAAQjC,MAAR,GAAiB,CAAhC,EAAmC;AAC/B,qCAAK,IAAIF,MAAI,CAAb,EAAgBA,MAAImC,QAAQjC,MAA5B,EAAoCF,KAApC,EAAyC;AACrC,wCAAImC,QAAQnC,GAAR,EAAWqC,KAAX,CAAiBnC,MAAjB,GAA0B,CAA9B,EAAiC;AAC7B,6CAAK,IAAIoC,IAAI,CAAb,EAAgBA,IAAIH,QAAQnC,GAAR,EAAWqC,KAAX,CAAiBnC,MAArC,EAA6CoC,GAA7C,EAAkD;AAC9CH,oDAAQnC,GAAR,EAAWqC,KAAX,CAAiBC,CAAjB,EAAoBjC,GAApB,GAA0B7B,KAAKwB,GAAL,CAA1B;AACAoC,uDAAW1C,IAAX,CAAgByC,QAAQnC,GAAR,EAAWqC,KAAX,CAAiBC,CAAjB,CAAhB;AACH;AACD;AACH;AACJ;AACJ;AACD,mCAAOF,UAAP;AACH,yBAfE,EAgBFG,KAhBE,CAgBI,UAAUC,MAAV,EAAkB;AACrB9B,oCAAQ+B,GAAR,CAAYD,MAAZ;AACH,yBAlBE,CAAP;AAmBH;;;gDAGWtB,O,EAAS;AACjB,4BAAI1C,OAAO0C,QAAQwB,IAAR,EAAX;AACA,4BAAIb,WAAW,EAAf;AACA,4BAAIc,KAAJ;AACA,4BAAIC,YAAY,EAAhB;AACA,4BAAIC,UAAU,qBAAd;AACA,4BAAIC,MAAJ;AACA,4BAAIC,SAAU,EAAE,gBAAgB,kBAAlB,EAAd;AAPiB;AAAA;AAAA;;AAAA;AAQjB,kDAAgBvE,IAAhB,mIAAsB;AAAA,oCAAb6B,GAAa;;AAClBsC,wCAAQK,MAAMC,IAAN,CAAW,IAAIC,GAAJ,CAAQhC,QAAQI,GAAR,CAAYjB,GAAZ,CAAR,CAAX,CAAR;AACA,oCAAIsC,MAAMzC,MAAN,GAAe,CAAnB,EAAsB;AAClB0C,gDAAY,8BAA8BD,MAAM,CAAN,CAA9B,GAAyC,KAArD;AACA,yCAAK,IAAI3C,IAAI,CAAb,EAAgBA,IAAI2C,MAAMzC,MAA1B,EAAkCF,GAAlC,EAAuC;AACnC,4CAAIA,MAAM2C,MAAMzC,MAAN,GAAa,CAAvB,EAA0B;AACtB0C,yDAAa,0BAA0BD,MAAM3C,CAAN,CAA1B,GAAqC,MAAlD;AACH,yCAFD,MAEO;AACH4C,yDAAa,8BAA8BD,MAAM3C,CAAN,CAA9B,GAAyC,KAAtD;AACH;AACJ;AACJ,iCATD,MASO;AACH4C,gDAAY,0BAA0BD,MAAM,CAAN,CAA1B,GAAqC,MAAjD;AACH;AACDG,yCAAS;AACLK,2CAAO,IADF;AAELC,4CAAQ,CAFH;AAGLC,4CAAQ,iBAHH;AAILC,2CAAOV,SAJF;AAKLC,6CAASA;AALJ,iCAAT;AAOAhB,yCAASnC,IAAT,CAAc,KAAKsC,cAAL,CAAoB,MAApB,EAA2B,IAA3B,EAAgC3B,MAAK,iCAAL,GAAuC,IAAIkD,eAAJ,CAAoBT,MAApB,EAA4BU,QAA5B,EAAvE,EAA+GT,MAA/G,CAAd;AACA;AACH;AA/BgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAgCjB,+BAAOd,QAAQC,GAAR,CAAYL,QAAZ,EACFrB,IADE,CACG,UAAU2B,OAAV,EAAmB;AACrB,gCAAIsB,cAAc,EAAlB;AACA,gCAAItB,WAAWA,QAAQjC,MAAR,GAAiB,CAAhC,EAAmC;AAC/B,qCAAK,IAAIF,IAAI,CAAb,EAAgBA,IAAImC,QAAQjC,MAA5B,EAAoCF,GAApC,EAAyC;AACrC,wCAAImC,QAAQnC,CAAR,EAAWyB,QAAX,IAAuBU,QAAQnC,CAAR,EAAWyB,QAAX,CAAoBvB,MAApB,GAA6B,CAAxD,EAA2D;AACvDuD,oDAAY/D,IAAZ,uCAAoByC,QAAQnC,CAAR,EAAWyB,QAA/B;AACH;AACJ;AACJ;AACD,mCAAOgC,WAAP;AACH,yBAXE,EAWAlB,KAXA,CAWM,UAAUC,MAAV,EAAkB;AACvB9B,oCAAQ+B,GAAR,CAAYD,MAAZ;AACH,yBAbE,CAAP;AAcH;;;mDAEckB,I,EAAM5B,O,EAAS6B,U,EAAYZ,M,EAAO;AAC7C,+BAAOrF,EAAEkG,IAAF,CAAO;AACVF,kCAAMA,IADI;AAEVrD,iCAAKsD,UAFK;AAGV7D,kCAAMgC,OAHI;AAIViB,oCAAQA;AAJE,yBAAP,CAAP;AAMH;;;+CAEU,CACV;;;+CAEUc,I,EAAMC,I,EAAM;AACnB,4BAAIlG,aAAaiG,KAAK/E,KAAL,CAAWC,OAAX,CAAmBnB,UAApC;AACA,4BAAIC,QAAQgG,KAAK/E,KAAL,CAAWC,OAAX,CAAmBlB,KAAnB,GAAyB,IAArC;AACA,4BAAIC,QAAQ+F,KAAK/E,KAAL,CAAWC,OAAX,CAAmBjB,KAAnB,GAAyB,IAArC;AACA,4BAAIiG,YAAYD,KAAKE,QAAL,CAAc,CAAd,EAAiBA,QAAjB,CAA0B,CAA1B,CAAhB;AACAD,kCAAUE,SAAV,GAAsB,CAAtB;AACA,4BAAIJ,KAAK/E,KAAL,CAAWC,OAAX,CAAmBN,QAAnB,IAA+B,IAAnC,EAAyC;AACrCyF,0CAAcL,KAAK/E,KAAL,CAAWC,OAAX,CAAmBN,QAAjC;AACAoF,iCAAK/E,KAAL,CAAWC,OAAX,CAAmBN,QAAnB,GAA8B,IAA9B;AACH;AACD,iCAAS0F,KAAT,CAAe7D,IAAf,EAAqB;AACjB,gCAAIA,KAAKxB,KAAL,CAAWC,OAAX,CAAmBN,QAAnB,IAA+B,IAAnC,EAAyC;AACrC6B,qCAAKxB,KAAL,CAAWC,OAAX,CAAmBN,QAAnB,GAA8B2F,YAAYC,SAAZ,EAAuBxG,KAAvB,CAA9B;AACH;AACDkG,sCAAUE,SAAV,IAAuBrG,UAAvB;AACH;AACD,iCAASyG,SAAT,GAAqB;AACjB,gCAAIN,UAAUE,SAAV,GAAoB,CAApB,IAAyBF,UAAUO,YAAV,GAAyBP,UAAUQ,YAAhE,EAA6E;AACzER,0CAAUE,SAAV,GAAsB,CAAtB;AACA;AACH;AACDF,sCAAUE,SAAV,IAAuBrG,UAAvB;AACA,gCAAImG,UAAUE,SAAV,GAAsBF,UAAUO,YAAV,GAAyBP,UAAUQ,YAA7D,EAA0E;AACtER,0CAAUE,SAAV,GAAsBF,UAAUO,YAAV,GAAyBP,UAAUQ,YAAzD;AACH;AACD;AACA;AACA;AACA;AACA;AACH;AACD,4BAAIR,UAAUS,YAAV,IAA0BT,UAAUO,YAAxC,EAAsD;AAClDG,uCAAWN,KAAX,EAAkBrG,KAAlB,EAAwB+F,IAAxB;AACH;AACJ;;;oDAEe;AACZ,4BAAI,KAAK/D,IAAL,IAAa,IAAb,IAAqB,KAAKA,IAAL,CAAUI,MAAV,GAAmB,CAA5C,EAA+C;AAC3C;AACH;AACD,4BAAIwE,MAAM,IAAIvD,GAAJ,EAAV;AAJY;AAAA;AAAA;;AAAA;AAKZ,kDAAuB,KAAKrC,KAAL,CAAWC,OAAX,CAAmBf,WAA1C,mIAAuD;AAAA,oCAA9C2G,UAA8C;;AACnDD,oCAAInD,GAAJ,CAAQoD,WAAWhF,IAAnB,EAAyBgF,WAAWvG,IAApC;AACH;AAPW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAQZ,4BAAIwG,WAAW,EAAf;AACA,4BAAIC,SAAS,EAAb;AACA,4BAAIC,SAAS,CAAb;AACA,4BAAIC,MAAJ;AACA,6BAAK,IAAI/E,IAAI,CAAb,EAAgBA,IAAI,KAAKF,IAAL,CAAUI,MAA9B,EAAsCF,GAAtC,EAA2C;AACvC4E,uCAAW,KAAK9E,IAAL,CAAUE,CAAV,EAAaL,IAAxB;AACAoF,qCAAS,EAAT;AACA,gCAAGL,IAAIrD,GAAJ,CAAQuD,SAASI,SAAT,CAAmB,CAAnB,EAAqB,CAArB,CAAR,CAAH,EAAqC;AACjCD,yCAASL,IAAIpD,GAAJ,CAAQsD,SAASI,SAAT,CAAmB,CAAnB,EAAqB,CAArB,CAAR,CAAT;AACH;AACDH,qCAASD,SAASI,SAAT,CAAmB,CAAnB,EAAqB,CAArB,CAAT;AACAF,qCAASG,OAAOL,SAASI,SAAT,CAAmB,CAAnB,EAAqB,CAArB,CAAP,CAAT;AACA,iCAAKlF,IAAL,CAAUE,CAAV,EAAakF,OAAb,GAAwBH,UAAQ,CAACF,WAAS,GAAT,GAAa,CAAb,GAAe,CAAhB,IAAmBC,MAA3B,IAAqC,KAAtC,IAAgD,KAAKhF,IAAL,CAAUE,CAAV,EAAa5B,IAAb,GAAkB,KAAK0B,IAAL,CAAUE,CAAV,EAAa5B,IAA/B,GAAoC,EAApF,CAAvB;AACH;AACJ;;;oDAEeC,K,EAAO;AACnB,4BAAI8G,UAAU,EAAd;AACA,4BAAI5G,gBAAgB,KAAKO,KAAL,CAAWC,OAAX,CAAmBR,aAAvC;AACA,4BAAIA,cAAcF,QAAM,CAApB,KAA0B,IAA1B,IAAkCE,cAAcF,QAAM,CAApB,EAAuB6B,MAAvB,GAAgC,CAAtE,EAAyE;AACrEiF,sCAAU5G,cAAcF,QAAM,CAApB,CAAV;AACH,yBAFD,MAEO;AACH8G,sCAAU9G,KAAV;AACH;AACD,+BAAO8G,OAAP;AACH;;;yCAEIC,K,EAAOtB,I,EAAMuB,K,EAAOxB,I,EAAM;AAC3BA,6BAAK7E,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,YAAY;AACjC,gCAAIxB,EAAE6H,OAAF,CAAUzB,KAAK/D,IAAf,CAAJ,EAA0B;AAC1B+D,iCAAK0B,aAAL;AACA,iCAAK,IAAIvF,IAAI,CAAb,EAAgBA,IAAI6D,KAAK/D,IAAL,CAAUI,MAA9B,EAAsCF,GAAtC,EAA2C;AACvC,oCAAI6D,KAAK/D,IAAL,CAAUE,CAAV,EAAa3B,KAAb,IAAsB,CAA1B,EAA6B;AACzBwF,yCAAK/D,IAAL,CAAUE,CAAV,EAAawF,EAAb,GAAkB3B,KAAK/E,KAAL,CAAWC,OAAX,CAAmBb,MAAnB,CAA0B,CAA1B,CAAlB;AACH,iCAFD,MAEO,IAAI2F,KAAK/D,IAAL,CAAUE,CAAV,EAAa3B,KAAb,IAAsB,CAA1B,EAA6B;AAChCwF,yCAAK/D,IAAL,CAAUE,CAAV,EAAawF,EAAb,GAAkB3B,KAAK/E,KAAL,CAAWC,OAAX,CAAmBb,MAAnB,CAA0B,CAA1B,CAAlB;AACH,iCAFM,MAEA,IAAI2F,KAAK/D,IAAL,CAAUE,CAAV,EAAa3B,KAAb,IAAsB,CAA1B,EAA6B;AAChCwF,yCAAK/D,IAAL,CAAUE,CAAV,EAAawF,EAAb,GAAkB3B,KAAK/E,KAAL,CAAWC,OAAX,CAAmBb,MAAnB,CAA0B,CAA1B,CAAlB;AACH;AACD2F,qCAAK/D,IAAL,CAAUE,CAAV,EAAa3B,KAAb,GAAqBwF,KAAK4B,eAAL,CAAqB5B,KAAK/D,IAAL,CAAUE,CAAV,EAAa3B,KAAlC,CAArB;AACH;AACD,gCAAIqH,WAAW5B,KAAK6B,IAAL,CAAU,qBAAV,CAAf,CAbiC,CAagB;AACjD9B,iCAAK+B,UAAL,CAAgB/B,IAAhB,EAAqB6B,SAAS,CAAT,CAArB;AACH,yBAfD;AAgBH;;;;cAjR6BlI,gB;;;;AAoRlCkB,yBAAamH,WAAb,GAA2B,aAA3B","file":"alarm_ctrl.js","sourcesContent":["import {\r\n    MetricsPanelCtrl\r\n}\r\nfrom 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport $ from 'jquery';\r\n\r\nvar panelDefaults = {\r\n    stepLength: 32,\r\n    speed: 1,\r\n    delay: 1,\r\n    alarmNum: 50,\r\n    dcCodeRules: [],\r\n    alarmCodeRules: \"\",\r\n    colors: [\"rgba(50, 172, 45, 0.97)\", \"rgba(237, 129, 40, 0.89)\",\r\n        \"rgba(245, 54, 54, 0.9)\"\r\n    ],\r\n    colorOption: [{\r\n        name: '禁用',\r\n        value: 'Null'\r\n    }, {\r\n        name: '单元格',\r\n        value: 'cell'\r\n    }, {\r\n        name: '值',\r\n        value: 'value'\r\n    }, {\r\n        name: '行',\r\n        value: 'row'\r\n    }],\r\n    colorMode: 'cell',\r\n    alarmValNames:[\"\",\"\",\"\"],\r\n    urls: [],\r\n    interval: null\r\n}\r\nexport class OgeAlarmCtrl extends MetricsPanelCtrl {\r\n    constructor($scope, $injector) {\r\n        super($scope, $injector);\r\n        _.defaults(this.panel, {\r\n            options: {}\r\n        });\r\n        _.defaults(this.panel.options, panelDefaults);\r\n\r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        this.events.on('data-received', this.onDataReceived.bind(this));\r\n        this.events.on('render', this.onRender.bind(this));\r\n    }\r\n    onInitEditMode() {\r\n        this.addEditorTab('Options',\r\n            'public/plugins/oge-alarm/editor.html', 2);\r\n    }\r\n\r\n    onDcDelete(index) {\r\n        this.panel.options.dcCodeRules.splice(index,1);\r\n        this.render();\r\n    }\r\n\r\n    onDcAdd() {\r\n        this.panel.options.dcCodeRules.push({code:\"\",name:\"\"});\r\n        this.render();\r\n    }\r\n\r\n    invertColorOrder() {\r\n        this.panel.options.colors.reverse();\r\n        this.render();\r\n    }\r\n\r\n    onDataReceived(dataList) {\r\n        this.data = [];\r\n        this.panel.options.urls = [];\r\n        if (this.panel.datasource == \"-- Mixed --\") {\r\n            for (let i = 0; i < this.panel.targets.length; i++) {\r\n                this.panel.options.urls.push(this.datasourceSrv.datasources[this.panel.targets[i].datasource].url);\r\n            }\r\n        } else {\r\n            this.panel.options.urls.push(this.datasource.url);\r\n        }\r\n        if (this.panel.options.urls.length == 0) {\r\n            return;\r\n        }\r\n        let that = this;\r\n        //查询所有数据源下报警信息\r\n        this.getAlarmData(this.panel.options.urls).then(function (alarmInfors) {\r\n            if (alarmInfors.length == 0) {\r\n                console.error(\"no data found alarm\");\r\n                return;\r\n            } else {\r\n                //按时间进行排序取最新的alarmNum条数\r\n                alarmInfors.sort(function (a,b) {\r\n                    return new Date(b.time).getTime() - new Date(a.time).getTime();\r\n                });\r\n                if (alarmInfors.length > that.panel.options.alarmNum) {\r\n                    alarmInfors.splice(that.panel.options.alarmNum);\r\n                }\r\n                //查询编码名称\r\n                var codeMap = new Map();\r\n                var urls = [];\r\n                for (let alarmInfor of alarmInfors) {\r\n                    urls = [];\r\n                    if (codeMap.has(alarmInfor.url)) {\r\n                        urls = codeMap.get(alarmInfor.url);\r\n                        urls.push(alarmInfor.code);\r\n                        codeMap.set(alarmInfor.url,urls);\r\n                    } else {\r\n                        codeMap.set(alarmInfor.url,[alarmInfor.code]);\r\n                    }\r\n                }\r\n                that.getKksCodes(codeMap).then(function (KKSInfos) {\r\n                    codeMap.clear();\r\n                    if (KKSInfos && KKSInfos.length > 0) {\r\n                        for (let i = 0; i < KKSInfos.length; i++) {\r\n                            if (KKSInfos[i].kksName && KKSInfos[i].kksName !== '') {\r\n                                codeMap.set(KKSInfos[i].kksCode, KKSInfos[i].kksName);\r\n                            }\r\n                        }\r\n                        for (let alarmInfor of alarmInfors) {\r\n                            if (codeMap.has(alarmInfor.code)) {\r\n                                alarmInfor.name = codeMap.get(alarmInfor.code);\r\n                            }\r\n                        }\r\n                    }\r\n                    that.data = alarmInfors;\r\n                    that.render();\r\n                });\r\n            }\r\n        })\r\n    }\r\n\r\n    getAlarmData(urls) {\r\n        var promises = [];\r\n        for (let i = 0; i < urls.length; i++) {\r\n            var getData = {\r\n                method: 'getNewLimitAlarm',\r\n                alarmNum: this.panel.options.alarmNum,\r\n                alarmCodeRules: this.panel.options.alarmCodeRules,\r\n            };\r\n            promises[i] = this.getAjaxPromise(\"GET\", getData,urls[i]+\"/kxmData\");\r\n        }\r\n        return Promise.all(promises)\r\n            .then(function (results) {\r\n                var alarmInfos = [];\r\n                if (results && results.length > 0) {\r\n                    for (let i = 0; i < results.length; i++) {\r\n                        if (results[i].Alarm.length > 0) {\r\n                            for (let j = 0; j < results[i].Alarm.length; j++) {\r\n                                results[i].Alarm[j].url = urls[i];\r\n                                alarmInfos.push(results[i].Alarm[j]);\r\n                            }\r\n                            // alarmInfos.push(...results[i].Alarm);\r\n                        }\r\n                    }\r\n                }\r\n                return alarmInfos;\r\n            })\r\n            .catch(function (reason) {\r\n                console.log(reason);\r\n            });\r\n    }\r\n\r\n    //获取编码\r\n    getKksCodes(codeMap) {\r\n        let urls = codeMap.keys();\r\n        var promises = [];\r\n        var codes;\r\n        var queryName = \"\";\r\n        var orderby = \"[('kksCode','ASC')]\";\r\n        var params;\r\n        var header =  { 'Content-Type': 'application/json' };\r\n        for (let url of urls) {\r\n            codes = Array.from(new Set(codeMap.get(url)));\r\n            if (codes.length > 1) {\r\n                queryName = \"['|',('kksCode','like','%\" + codes[0] + \"%')\";\r\n                for (let i = 1; i < codes.length; i++) {\r\n                    if (i === codes.length-1) {\r\n                        queryName += \",('kksCode','like','%\" + codes[i] + \"%')]\";\r\n                    } else {\r\n                        queryName += \",'|',('kksCode','like','%\" + codes[i] + \"%')\";\r\n                    }\r\n                }\r\n            } else {\r\n                queryName = \"[('kksCode','like','%\" + codes[0] + \"%')]\";\r\n            }\r\n            params = {\r\n                limit: 1000,\r\n                offset: 1,\r\n                fields: 'kksCode,kksName',\r\n                query: queryName,\r\n                orderby: orderby\r\n            }\r\n            promises.push(this.getAjaxPromise(\"POST\",null,url+ '/kksInfo?method=searchKKSInfos&'+new URLSearchParams(params).toString(), header));\r\n            // promises.push(this.getAjaxPromise(\"POST\",null,url+ '/kksInfo?method=searchKKSInfos&offset=1&limit=1000&fields=kksCode&query='+queryName+'&orderby='+orderby, header));\r\n        }\r\n        return Promise.all(promises)\r\n            .then(function (results) {\r\n                var codeTargets = [];\r\n                if (results && results.length > 0) {\r\n                    for (let i = 0; i < results.length; i++) {\r\n                        if (results[i].KKSInfos && results[i].KKSInfos.length > 0) {\r\n                            codeTargets.push(...results[i].KKSInfos);\r\n                        }\r\n                    }\r\n                }\r\n                return codeTargets;\r\n            }).catch(function (reason) {\r\n                console.log(reason);\r\n            });\r\n    }\r\n\r\n    getAjaxPromise(type, getData, requestUrl, header){\r\n        return $.ajax({\r\n            type: type,\r\n            url: requestUrl,\r\n            data: getData,\r\n            header: header\r\n        });\r\n    }\r\n\r\n    onRender() {\r\n    }\r\n\r\n    autoScroll(ctrl, elem) {\r\n        let stepLength = ctrl.panel.options.stepLength;\r\n        let speed = ctrl.panel.options.speed*1000;\r\n        let delay = ctrl.panel.options.delay*1000;\r\n        let tBodyElem = elem.children[0].children[1];\r\n        tBodyElem.scrollTop = 0;\r\n        if (ctrl.panel.options.interval != null) {\r\n            clearInterval(ctrl.panel.options.interval);\r\n            ctrl.panel.options.interval = null;\r\n        }\r\n        function start(that) {\r\n            if (that.panel.options.interval == null) {\r\n                that.panel.options.interval = setInterval(scrolling, speed);\r\n            }\r\n            tBodyElem.scrollTop += stepLength;\r\n        }\r\n        function scrolling() {\r\n            if (tBodyElem.scrollTop+1 >= tBodyElem.scrollHeight - tBodyElem.offsetHeight){\r\n                tBodyElem.scrollTop = 0;\r\n                return;\r\n            }\r\n            tBodyElem.scrollTop += stepLength;\r\n            if (tBodyElem.scrollTop > tBodyElem.scrollHeight - tBodyElem.offsetHeight){\r\n                tBodyElem.scrollTop = tBodyElem.scrollHeight - tBodyElem.offsetHeight;\r\n            }\r\n            //if (sTop === elem.scrollTop || sTop == 0 || elem.scrollTop === (elem.scrollHeight - elem.offsetHeight)) {\r\n            //    stepLength *= -1; // 转换方向\r\n            //    clearInterval(interval);\r\n            //    setTimeout(start, delay);\r\n            //}\r\n        }\r\n        if (tBodyElem.clientHeight <= tBodyElem.scrollHeight) {\r\n            setTimeout(start, delay,ctrl);\r\n        }\r\n    }\r\n\r\n    dcNameConvert() {\r\n        if (this.data == null || this.data.length < 1) {\r\n            return;\r\n        }\r\n        var map = new Map();\r\n        for (let dcCodeRule of this.panel.options.dcCodeRules) {\r\n            map.set(dcCodeRule.code, dcCodeRule.name);\r\n        }\r\n        var tempCode = \"\";\r\n        var tempPQ = \"\";\r\n        var tempJz = 0;\r\n        var dcName;\r\n        for (let i = 0; i < this.data.length; i++) {\r\n            tempCode = this.data[i].code;\r\n            dcName = \"\";\r\n            if(map.has(tempCode.substring(0,5))) {\r\n                dcName = map.get(tempCode.substring(0,5));\r\n            }\r\n            tempPQ = tempCode.substring(6,7);\r\n            tempJz = Number(tempCode.substring(7,8));\r\n            this.data[i].content = (dcName+((tempPQ===\"P\"?0:9)+tempJz) + \"号机组\") + (this.data[i].name?this.data[i].name:\"\");\r\n        }\r\n    }\r\n\r\n    alermValConvert(value) {\r\n        var valName = \"\";\r\n        var alarmValNames = this.panel.options.alarmValNames;\r\n        if (alarmValNames[value-1] != null && alarmValNames[value-1].length > 0) {\r\n            valName = alarmValNames[value-1];\r\n        } else {\r\n            valName = value;\r\n        }\r\n        return valName;\r\n    }\r\n\r\n    link(scope, elem, attrs, ctrl) {\r\n        ctrl.events.on('render', function () {\r\n            if (_.isEmpty(ctrl.data)) return;\r\n            ctrl.dcNameConvert();\r\n            for (var i = 0; i < ctrl.data.length; i++) {\r\n                if (ctrl.data[i].value == 1) {\r\n                    ctrl.data[i].CO = ctrl.panel.options.colors[0];\r\n                } else if (ctrl.data[i].value == 2) {\r\n                    ctrl.data[i].CO = ctrl.panel.options.colors[1];\r\n                } else if (ctrl.data[i].value == 3) {\r\n                    ctrl.data[i].CO = ctrl.panel.options.colors[2];\r\n                }\r\n                ctrl.data[i].value = ctrl.alermValConvert(ctrl.data[i].value);\r\n            }\r\n            var rootElem = elem.find('.table-panel-scroll'); //表格需要处理高度\r\n            ctrl.autoScroll(ctrl,rootElem[0]);\r\n        });\r\n    }\r\n}\r\n\r\nOgeAlarmCtrl.templateUrl = 'module.html';"]}