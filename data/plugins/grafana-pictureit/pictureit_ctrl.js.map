{"version":3,"sources":["../src/pictureit_ctrl.js"],"names":["_","isNumber","MetricsPanelCtrl","kbn","panelDefaults","valueMaps","seriesList","series","bgimage","sensors","height","width","mode","PictureItCtrl","$scope","$injector","templateSrv","defaults","panel","displayModeOptions","name","value","unitFormats","getUnitFormats","events","on","onInitEditMode","bind","render","onDataReceived","dataList","length","val","datapoints","push","refId","index","splice","arr","obj1","nameText","xlocation","ylocation","format","decimals","bgcolor","color","size","bordercolor","visible","rightType","rightObjectArr","link_name","link_url","id","displayMode","lastSensor","obj2","subItem","addEditorTab","url","link","replaceWithText","url2","replace","window","open","style","sen","console","log","scope","elem","attrs","ctrl","$panelContainer","find","pixelStrToNum","str","parseInt","substr","contextmenuFun","e","preventDefault","map","item","display","nextElementSibling","children","text","menu","xMiddle","offsetWidth","yMiddle","offsetHeight","xPostion","offsetParent","offsetLeft","yPostion","offsetTop","border","left","top","clinkFunRemove","which","css","sensorPointerCon","sensor","ylocationStr","toString","xlocationStr","sizeStr","addEventListener","filter","undefined","valueFormatted","toFixed","renderingCompleted","templateUrl"],"mappings":"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","file":"pictureit_ctrl.js","sourcesContent":["import _, { isNumber } from 'lodash';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport './sprintf.js';\r\nimport './angular-sprintf.js';\r\nimport kbn from 'app/core/utils/kbn';\r\n\r\nconst panelDefaults = {\r\n  valueMaps: [],\r\n  seriesList: [],\r\n  series: [],\r\n  bgimage: '',\r\n  sensors: [],\r\n  height: '400px',\r\n  width: '100px',\r\n  mode: '平铺'\r\n};\r\n\r\nexport class PictureItCtrl extends MetricsPanelCtrl {\r\n  constructor($scope, $injector, templateSrv) {\r\n    super($scope, $injector);\r\n    _.defaults(this.panel, panelDefaults);\r\n    this.displayModeOptions = [{\r\n      name: '文本',\r\n      value: 'text'\r\n    },\r\n    {\r\n      name: '值',\r\n      value: 'value'\r\n    }\r\n  ];\r\n\r\n    this.unitFormats = kbn.getUnitFormats();\r\n    this.templateSrv = templateSrv;\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('panel-initialized', this.render.bind(this));\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    this.panel.valueMaps = [];\r\n    for (let series = 0; series < dataList.length; series++) {\r\n      const val = dataList[series].datapoints && dataList[series].datapoints.length > 0 ? dataList[series].datapoints[dataList[series].datapoints.length - 1][0] : null;\r\n      this.panel.valueMaps.push({name: dataList[series].refId, value: val});\r\n    }\r\n    this.render();\r\n  }\r\n  deleteSensor(index) {\r\n    this.panel.sensors.splice(index, 1);\r\n  }\r\n\r\n  removeRightObj(arr, index) {\r\n    arr.splice(index, 1);\r\n  }\r\n  addSensor() {\r\n    if (this.panel.sensors.length === 0) {\r\n      const obj1 = {\r\n        name: 'A',\r\n        nameText: 'A-series',\r\n        xlocation: 200,\r\n        ylocation: 200,\r\n        format: 'none',\r\n        decimals: 2,\r\n        bgcolor: 'rgba(0, 0, 0, 0.58)',\r\n        color: '#FFFFFF',\r\n        size: 22,\r\n        bordercolor: 'rgb(251, 4, 4)',\r\n        visible: true,\r\n        rightType: false,\r\n        rightObjectArr: [\r\n          {\r\n            link_name: '',\r\n            link_url: '',\r\n            id: 'a' + 1 + 'b' + 1\r\n          }\r\n        ],\r\n        displayMode: 'text'\r\n      };\r\n      this.panel.sensors.push(obj1);\r\n    } else {\r\n      const lastSensor = this.panel.sensors[this.panel.sensors.length - 1];\r\n      const obj2 = {\r\n        name: lastSensor.name,\r\n        nameText: lastSensor.nameText,\r\n        xlocation: 200,\r\n        ylocation: 200,\r\n        format: lastSensor.format,\r\n        decimals: lastSensor.decimals,\r\n        bgcolor: lastSensor.bgcolor,\r\n        color: lastSensor.color,\r\n        size: lastSensor.size,\r\n        bordercolor: lastSensor.bordercolor,\r\n        visible: true,\r\n        rightType: false,\r\n        rightObjectArr: [\r\n          {\r\n            link_name: '',\r\n            link_url: '',\r\n            id: 'a' + this.panel.sensors.length + 'b' + 1\r\n          }\r\n        ],\r\n        displayMode: 'text'\r\n      };\r\n      this.panel.sensors.push(obj2);\r\n    }\r\n  }\r\n\r\n  addRightObj(arr) {\r\n    arr.push({link_name: '', link_url: '', id: 'a' + this.panel.sensors.length + 'b' + (arr.length + 1)});\r\n  }\r\n\r\n  setUnitFormat(subItem, index) {\r\n    this.panel.sensors[index].format = subItem.value;\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Options', 'public/plugins/bessler-pictureit-panel/editor.html', 2);\r\n  }\r\n\r\n  clickSensor(url) {\r\n    const link = this.templateSrv.replaceWithText(url, null);\r\n    const url2 = link.replace(/\\#/g, '%23');\r\n    window.open(url2, '_self');\r\n  }\r\n\r\n  mainStyle() {\r\n    let style;\r\n    if (this.panel.mode === '平铺') {\r\n      style = {\r\n        'height': this.height,\r\n        'width': '100%',\r\n        'background-size': '100% 100%',\r\n        'background-repeat': 'no-repeat',\r\n        'background-image': 'url(' + this.panel.bgimage + ')'\r\n      };\r\n    } else {\r\n      style = {\r\n        'height': this.height,\r\n        'width': '100%',\r\n        'background-repeat': 'no-repeat',\r\n        'background-image': 'url(' + this.panel.bgimage + ')',\r\n        'background-position': 'center'\r\n      };\r\n    }\r\n    return style;\r\n  }\r\n\r\n  changeDisplayMode(sen) {\r\n    console.log(sen);\r\n  }\r\n  link(scope, elem, attrs, ctrl) {\r\n    let sensors;\r\n\r\n    const $panelContainer = elem.find('.panel-container');\r\n\r\n    function pixelStrToNum(str) {\r\n      return parseInt(str.substr(0, str.length - 2));\r\n    }\r\n    function contextmenuFun(e) {\r\n      e.preventDefault();\r\n      $panelContainer.find('.pictureitCtrlP').find('.dropdown-menu').map(item => {\r\n        $panelContainer.find('.pictureitCtrlP').find('.dropdown-menu')[item].style.display = 'none';\r\n      });\r\n      if (this.nextElementSibling.children.length === 1 && this.nextElementSibling.children[0].children[0].text === '') return;\r\n      const menu = this.nextElementSibling;\r\n      const xMiddle = $panelContainer[0].offsetWidth / 2;\r\n      const yMiddle = $panelContainer[0].offsetHeight / 2;\r\n      const xPostion = this.offsetParent.offsetLeft;\r\n      const yPostion = this.offsetParent.offsetTop;\r\n      menu.style.border = '1px solid #000000';\r\n      menu.style.display = 'block';\r\n      if (xPostion < xMiddle && yPostion < yMiddle) {\r\n        menu.style.left = 0;\r\n        menu.style.top = this.offsetHeight + 'px';\r\n      } else if (xPostion > xMiddle && yPostion < yMiddle) {\r\n        menu.style.left = this.offsetWidth - menu.offsetWidth + 'px';\r\n        menu.style.top = this.offsetHeight + 'px';\r\n      } else if (xPostion < xMiddle && yPostion > yMiddle) {\r\n        menu.style.left = 0;\r\n        menu.style.top = 0 - menu.offsetHeight + 'px';\r\n      } else {\r\n        menu.style.left = this.offsetWidth - menu.offsetWidth + 'px';\r\n        menu.style.top = 0 - menu.offsetHeight + 'px';\r\n      }\r\n    }\r\n\r\n    function clinkFunRemove(e) {\r\n      if (e.which === 1) { // 兼容firefox\r\n        $panelContainer.find('.pictureitCtrlP').find('.dropdown-menu').map(item => {\r\n          $panelContainer.find('.pictureitCtrlP').find('.dropdown-menu')[item].style.display = 'none';\r\n        });\r\n      }\r\n    }\r\n    function render() {\r\n      if (!ctrl.panel.sensors) { return; }\r\n\r\n      const width = pixelStrToNum($panelContainer.css('width'));\r\n      const height = pixelStrToNum($panelContainer.css('height'));\r\n      const sensorPointerCon = $panelContainer.find('.sensor-point');\r\n      sensors = ctrl.panel.sensors;\r\n      for (let sensor = 0; sensor < sensors.length; sensor++) {\r\n        sensors[sensor].visible = sensors[sensor].xlocation >= 0 && sensors[sensor].xlocation <= 100 && sensors[sensor].ylocation >= 0 && sensors[sensor].ylocation <= 100;\r\n        sensors[sensor].ylocationStr = (sensors[sensor].ylocation / 100 * height).toString() + 'px';\r\n        sensors[sensor].xlocationStr = (sensors[sensor].xlocation / 100 * width).toString() + 'px';\r\n        sensors[sensor].sizeStr = sensors[sensor].size.toString() + 'px';\r\n        // removeEventListener\r\n        if (sensorPointerCon[sensor]) {\r\n          sensorPointerCon[sensor].addEventListener('contextmenu', contextmenuFun, false);\r\n          $panelContainer.find('.pictureitCtrlP')[0].addEventListener('click', clinkFunRemove, false);\r\n        }\r\n\r\n        if (sensors[sensor].displayMode === 'value') {\r\n          const val = ctrl.panel.valueMaps.filter(item => { return item.name === sensors[sensor].name; });\r\n          if (val.length > 0 && val[0].value !== undefined) {\r\n            // sensors[sensor].valueFormatted = kbn.valueFormats[sensors[sensor].format](val[0].value, sensors[sensor].decimals, null);\r\n            sensors[sensor].valueFormatted = val[0].value.toFixed(sensors[sensor].decimals) - 0 + sensors[sensor].format;\r\n          } else {\r\n            sensors[sensor].valueFormatted = '';\r\n          }\r\n        } else {\r\n          sensors[sensor].valueFormatted = sensors[sensor].nameText;\r\n        }\r\n      }\r\n    }\r\n\r\n    this.events.on('render', function () {\r\n      render();\r\n      ctrl.renderingCompleted();\r\n    });\r\n  }\r\n}\r\n\r\nPictureItCtrl.templateUrl = 'module.html';\r\n"]}